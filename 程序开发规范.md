# SpringBoot åº”ç”¨æ¨¡æ¿ - ç¨‹åºå¼€å‘è§„èŒƒ

> åŸºäº Spring Boot 3.5.6 + MyBatis-Plus 3.5.9 + Spring Security 6.x çš„ä¼ä¸šçº§åº”ç”¨å¼€å‘è§„èŒƒï¼ˆå®Œæ•´ç‰ˆï¼‰

---

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£æ˜¯ SpringBoot åº”ç”¨æ¨¡æ¿çš„å¼€å‘è§„èŒƒæŒ‡å—ï¼Œå®šä¹‰äº†åŸºäºæ­¤æ¨¡æ¿è¿›è¡Œé¡¹ç›®å¼€å‘çš„æ ‡å‡†æµç¨‹ã€ä»£ç è§„èŒƒã€æœ€ä½³å®è·µå’Œä½¿ç”¨æ–¹æ³•ã€‚

**å½“å‰ç‰ˆæœ¬**: v3.0.0 - æ¶µç›–é˜¶æ®µä¸€è‡³äº”ï¼ˆåŸºç¡€æ¶æ„ã€æ•°æ®è®¿é—®å±‚ã€å®‰å…¨ä¸è®¤è¯ã€æ—¥å¿—ä¸å¼‚å¸¸ã€æ–‡æ¡£ä¸ä¸šåŠ¡ï¼‰
**é€‚ç”¨èŒƒå›´**: æ‰€æœ‰åŸºäºæ­¤æ¨¡æ¿çš„ Spring Boot é¡¹ç›®å¼€å‘
**ç»´æŠ¤è´£ä»»**: é¡¹ç›®æ¶æ„å¸ˆå’ŒæŠ€æœ¯è´Ÿè´£äºº
**æ›´æ–°é¢‘ç‡**: æ¯ä¸ªé˜¶æ®µå®Œæˆåæ›´æ–°
**æœ€åæ›´æ–°**: 2025å¹´10æœˆ23æ—¥

---

## ğŸ—ï¸ é¡¹ç›®æ¶æ„è§„èŒƒ

### åˆ†å±‚æ¶æ„æ ‡å‡†

é¡¹ç›®é‡‡ç”¨ç»å…¸çš„åˆ†å±‚æ¶æ„æ¨¡å¼ï¼Œå„å±‚èŒè´£æ˜ç¡®ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Controller Layer            â”‚  â† REST API æ¥å£å±‚
â”‚        (@RestController)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        Service Layer               â”‚  â† ä¸šåŠ¡é€»è¾‘å±‚
â”‚        (@Service)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        Mapper Layer                â”‚  â† æ•°æ®è®¿é—®å±‚
â”‚        (@Mapper)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        Entity Layer                â”‚  â† å®ä½“æ¨¡å‹å±‚
â”‚        (BaseEntity)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        Common Layer                â”‚  â† é€šç”¨ç»„ä»¶å±‚
â”‚        (Utils, Enums, Config)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åŒ…ç»“æ„è§„èŒƒ

```
src/main/java/com/dawnmoon/springboot_app_template/
â”œâ”€â”€ SpringbootAppTemplateApplication.java    # ä¸»å¯åŠ¨ç±»
â”œâ”€â”€ controller/                              # æ§åˆ¶å™¨å±‚
â”‚   â”œâ”€â”€ AuthController.java                 # è®¤è¯æ§åˆ¶å™¨
â”‚   â””â”€â”€ UserController.java                 # ç”¨æˆ·ç®¡ç†æ§åˆ¶å™¨ âœ¨ æ–°å¢
â”œâ”€â”€ service/                                # æœåŠ¡å±‚
â”‚   â”œâ”€â”€ AuthService.java                   # è®¤è¯æœåŠ¡æ¥å£
â”‚   â”œâ”€â”€ UserService.java                   # ç”¨æˆ·æœåŠ¡æ¥å£
â”‚   â””â”€â”€ serviceImpl/                       # æœåŠ¡å®ç°
â”‚       â”œâ”€â”€ AuthServiceImpl.java           # è®¤è¯æœåŠ¡å®ç°
â”‚       â””â”€â”€ UserServiceImpl.java           # ç”¨æˆ·æœåŠ¡å®ç°
â”œâ”€â”€ mapper/                                 # æ•°æ®è®¿é—®å±‚
â”‚   â”œâ”€â”€ UserMapper.java                    # ç”¨æˆ·Mapperæ¥å£
â”‚   â”œâ”€â”€ RoleMapper.java                    # è§’è‰²Mapperæ¥å£
â”‚   â””â”€â”€ UserRoleMapper.java                # ç”¨æˆ·è§’è‰²å…³è”Mapper
â”œâ”€â”€ model/                                  # æ¨¡å‹å±‚
â”‚   â”œâ”€â”€ entity/                            # å®ä½“ç±»
â”‚   â”‚   â”œâ”€â”€ BaseEntity.java               # åŸºç¡€å®ä½“ç±»
â”‚   â”‚   â”œâ”€â”€ User.java                     # ç”¨æˆ·å®ä½“
â”‚   â”‚   â”œâ”€â”€ Role.java                     # è§’è‰²å®ä½“
â”‚   â”‚   â””â”€â”€ UserRole.java                 # ç”¨æˆ·è§’è‰²å…³è”å®ä½“
â”‚   â”œâ”€â”€ request/                          # è¯·æ±‚å‚æ•°å¯¹è±¡
â”‚   â”‚   â”œâ”€â”€ AuthRequests.java            # è®¤è¯è¯·æ±‚
â”‚   â”‚   â””â”€â”€ UserRequests.java            # ç”¨æˆ·è¯·æ±‚ âœ¨ æ–°å¢
â”‚   â””â”€â”€ response/                         # å“åº”å¯¹è±¡
â”‚       â”œâ”€â”€ PageResponse.java            # åˆ†é¡µå“åº”
â”‚       â””â”€â”€ UserResponse.java            # ç”¨æˆ·å“åº” âœ¨ æ–°å¢
â”œâ”€â”€ common/                                 # é€šç”¨ç»„ä»¶
â”‚   â”œâ”€â”€ api/                              # APIç›¸å…³
â”‚   â”‚   â””â”€â”€ ApiResponse.java             # ç»Ÿä¸€è¿”å›ä½“
â”‚   â”œâ”€â”€ enums/                            # æšä¸¾ç±»
â”‚   â”‚   â”œâ”€â”€ BaseEnum.java                # æšä¸¾åŸºç¡€æ¥å£
â”‚   â”‚   â””â”€â”€ ErrorCode.java               # é”™è¯¯ç æšä¸¾
â”‚   â”œâ”€â”€ exception/                        # å¼‚å¸¸å¤„ç† âœ¨ æ–°å¢
â”‚   â”‚   â”œâ”€â”€ BusinessException.java       # ä¸šåŠ¡å¼‚å¸¸
â”‚   â”‚   â””â”€â”€ GlobalExceptionHandler.java  # å…¨å±€å¼‚å¸¸å¤„ç†å™¨
â”‚   â”œâ”€â”€ log/                              # æ—¥å¿—ç»„ä»¶ âœ¨ æ–°å¢
â”‚   â”‚   â””â”€â”€ TraceIdFilter.java           # é“¾è·¯è¿½è¸ªè¿‡æ»¤å™¨
â”‚   â””â”€â”€ security/                         # å®‰å…¨ç»„ä»¶
â”‚       â”œâ”€â”€ SecurityUtil.java            # å®‰å…¨å·¥å…·ç±»
â”‚       â”œâ”€â”€ UserPrincipal.java           # ç”¨æˆ·è®¤è¯ä¸»ä½“
â”‚       â”œâ”€â”€ JwtAuthenticationFilter.java # JWTè®¤è¯è¿‡æ»¤å™¨
â”‚       â”œâ”€â”€ RestAuthenticationEntryPoint.java    # æœªè®¤è¯å¤„ç†å™¨
â”‚       â”œâ”€â”€ RestAccessDeniedHandler.java         # æƒé™ä¸è¶³å¤„ç†å™¨
â”‚       â”œâ”€â”€ EncryptedField.java          # åŠ å¯†å­—æ®µæ³¨è§£
â”‚       â””â”€â”€ EncryptedTypeHandler.java    # åŠ å¯†å­—æ®µå¤„ç†å™¨
â”œâ”€â”€ config/                                # é…ç½®ç±»
â”‚   â”œâ”€â”€ MybatisPlusConfig.java           # MyBatis-Plusé…ç½®
â”‚   â”œâ”€â”€ RedisConfig.java                 # Redisé…ç½®
â”‚   â”œâ”€â”€ SecurityConfig.java              # Spring Securityé…ç½®
â”‚   â””â”€â”€ Knife4jConfig.java               # Knife4jé…ç½® âœ¨ æ–°å¢
â””â”€â”€ util/                                  # å·¥å…·ç±»
    â”œâ”€â”€ PageUtil.java                     # åˆ†é¡µå·¥å…·ç±»
    â””â”€â”€ CryptoUtil.java                   # åŠ å¯†å·¥å…·ç±»
```

---

## ğŸ“ ä»£ç ç¼–å†™è§„èŒƒ

### å®ä½“ç±»è§„èŒƒ

#### 1. åŸºç¡€å®ä½“ç±» (BaseEntity)

æ‰€æœ‰å®ä½“ç±»å¿…é¡»ç»§æ‰¿ `BaseEntity`ï¼Œå®ƒæä¾›äº†é€šç”¨çš„åŸºç¡€å­—æ®µï¼š

```java
@Data
public abstract class BaseEntity implements Serializable {
    
    /**
     * ä¸»é”®ID - ä½¿ç”¨é›ªèŠ±ç®—æ³•è‡ªåŠ¨ç”Ÿæˆ
     * @TableId: MyBatis-Plusä¸»é”®æ³¨è§£
     * - value: æ•°æ®åº“å­—æ®µå
     * - type: ä¸»é”®ç”Ÿæˆç­–ç•¥ï¼ŒASSIGN_IDä½¿ç”¨é›ªèŠ±ç®—æ³•
     */
    @TableId(value = "id", type = IdType.ASSIGN_ID)
    private Long id;

    /**
     * åˆ›å»ºæ—¶é—´ - æ’å…¥æ—¶è‡ªåŠ¨å¡«å……
     * @TableField: MyBatis-Pluså­—æ®µæ³¨è§£
     * - value: æ•°æ®åº“å­—æ®µå
     * - fill: è‡ªåŠ¨å¡«å……ç­–ç•¥ï¼ŒINSERTè¡¨ç¤ºæ’å…¥æ—¶å¡«å……
     */
    @TableField(value = "create_at", fill = FieldFill.INSERT)
    private LocalDateTime createAt;

    /**
     * æ›´æ–°æ—¶é—´ - æ’å…¥å’Œæ›´æ–°æ—¶è‡ªåŠ¨å¡«å……
     * - fill: INSERT_UPDATEè¡¨ç¤ºæ’å…¥å’Œæ›´æ–°æ—¶éƒ½å¡«å……
     */
    @TableField(value = "update_at", fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updateAt;

    /**
     * åˆ›å»ºäºº - æ’å…¥æ—¶è‡ªåŠ¨å¡«å……
     */
    @TableField(value = "create_by", fill = FieldFill.INSERT)
    private Long createBy;

    /**
     * æ›´æ–°äºº - æ’å…¥å’Œæ›´æ–°æ—¶è‡ªåŠ¨å¡«å……
     */
    @TableField(value = "update_by", fill = FieldFill.INSERT_UPDATE)
    private Long updateBy;

    /**
     * é€»è¾‘åˆ é™¤æ ‡è¯† - 0: æœªåˆ é™¤, 1: å·²åˆ é™¤
     * @TableLogic: MyBatis-Plusé€»è¾‘åˆ é™¤æ³¨è§£
     * - value: æœªåˆ é™¤æ—¶çš„å€¼
     * - delval: åˆ é™¤æ—¶çš„å€¼
     */
    @TableLogic(value = "0", delval = "1")
    @TableField("is_deleted")
    private Integer isDeleted;
}
```

**å…³é”®æ³¨è§£è¯´æ˜**:
- `@Data`: Lombokæ³¨è§£ï¼Œè‡ªåŠ¨ç”Ÿæˆgetter/setter/toString/equals/hashCodeæ–¹æ³•
- `@TableId`: æ ‡è¯†ä¸»é”®å­—æ®µï¼Œé…ç½®ä¸»é”®ç”Ÿæˆç­–ç•¥
- `@TableField`: é…ç½®å­—æ®µæ˜ å°„å’Œè‡ªåŠ¨å¡«å……ç­–ç•¥
- `@TableLogic`: é…ç½®é€»è¾‘åˆ é™¤å­—æ®µ

#### 2. ä¸šåŠ¡å®ä½“ç±» (User)

```java
/**
 * ç”¨æˆ·å®ä½“ç±»
 * @Data: Lombokæ³¨è§£ï¼Œç”Ÿæˆgetter/setterç­‰æ–¹æ³•
 * @EqualsAndHashCode(callSuper = true): ç”Ÿæˆequalså’ŒhashCodeæ—¶åŒ…å«çˆ¶ç±»å­—æ®µ
 * @TableName: æŒ‡å®šæ•°æ®åº“è¡¨å
 */
@Data
@EqualsAndHashCode(callSuper = true)
@TableName("sys_user")
public class User extends BaseEntity {

    /**
     * ç”¨æˆ·å
     * @TableField: æŒ‡å®šæ•°æ®åº“å­—æ®µå
     */
    @TableField("username")
    private String username;

    /**
     * å¯†ç ï¼ˆBCryptåŠ å¯†ï¼‰
     */
    @TableField("password")
    private String password;

    /**
     * çœŸå®å§“å
     */
    @TableField("real_name")
    private String realName;

    /**
     * æ‰‹æœºå·
     */
    @TableField("phone")
    private String phone;

    /**
     * é‚®ç®±
     */
    @TableField("email")
    private String email;

    /**
     * å¤´åƒURL
     */
    @TableField("avatar")
    private String avatar;

    /**
     * è´¦å·çŠ¶æ€ï¼š0-å¯ç”¨ï¼Œ1-ç¦ç”¨
     */
    @TableField("status")
    private Integer status;

    /**
     * ç”¨æˆ·è§’è‰²åˆ—è¡¨ï¼ˆä¸å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œé€šè¿‡å…³è”æŸ¥è¯¢è·å–ï¼‰
     * @TableField(exist = false): è¡¨ç¤ºè¯¥å­—æ®µä¸å¯¹åº”æ•°æ®åº“å­—æ®µ
     */
    @TableField(exist = false)
    private List<String> roles;
}
```

### Controller å±‚è§„èŒƒ

#### 1. åŸºç¡€æ³¨è§£é…ç½®

```java
/**
 * è®¤è¯æˆæƒ Controller
 * @Tag: Swaggeræ–‡æ¡£æ³¨è§£ï¼Œå®šä¹‰æ¥å£åˆ†ç»„
 * @RestController: Spring MVCæ³¨è§£ï¼Œæ ‡è¯†RESTæ§åˆ¶å™¨ï¼Œè‡ªåŠ¨å°†è¿”å›å€¼åºåˆ—åŒ–ä¸ºJSON
 * @RequestMapping: å®šä¹‰æ§åˆ¶å™¨çš„åŸºç¡€è·¯å¾„
 * @RequiredArgsConstructor: Lombokæ³¨è§£ï¼Œä¸ºfinalå­—æ®µç”Ÿæˆæ„é€ å‡½æ•°
 * @Validated: å¯ç”¨æ–¹æ³•çº§åˆ«çš„å‚æ•°æ ¡éªŒ
 */
@Tag(name = "è®¤è¯æˆæƒ", description = "ç™»å½•ã€æ³¨å†Œç›¸å…³æ¥å£")
@RestController
@RequestMapping("/api/auth")
@RequiredArgsConstructor
@Validated
public class AuthController {
    // Controllerå®ç°
}
```

#### 2. æ¥å£æ–¹æ³•è§„èŒƒ

```java
/**
 * @Operation: Swaggeræ–‡æ¡£æ³¨è§£ï¼Œæè¿°æ¥å£åŠŸèƒ½
 * @PostMapping: Spring MVCæ³¨è§£ï¼Œå¤„ç†POSTè¯·æ±‚
 * @RequestBody: å°†è¯·æ±‚ä½“JSONè½¬æ¢ä¸ºJavaå¯¹è±¡
 * @Valid: å¯ç”¨Bean Validationæ ¡éªŒ
 */
@Operation(summary = "ç”¨æˆ·ç™»å½•", description = "éªŒè¯ç”¨æˆ·åå¯†ç ï¼Œè¿”å› Token")
@PostMapping("/login")
public ApiResponse<String> login(@RequestBody @Valid AuthRequests.LoginRequest request) {
    // TODO: å®ç°ç™»å½•é€»è¾‘
    return ApiResponse.success("mock-token-12345");
}
```

#### 3. ç»Ÿä¸€è¿”å›æ ¼å¼

æ‰€æœ‰æ¥å£å¿…é¡»ä½¿ç”¨ `ApiResponse` ç»Ÿä¸€è¿”å›æ ¼å¼ï¼š

```java
// æˆåŠŸå“åº”ï¼ˆæ— æ•°æ®ï¼‰
return ApiResponse.success();

// æˆåŠŸå“åº”ï¼ˆå¸¦æ•°æ®ï¼‰
return ApiResponse.success(data);

// æˆåŠŸå“åº”ï¼ˆè‡ªå®šä¹‰æ¶ˆæ¯ï¼‰
return ApiResponse.success("æ“ä½œæˆåŠŸ", data);

// å¤±è´¥å“åº”
return ApiResponse.error(ErrorCode.USER_NOT_FOUND);

return ApiResponse.error(ErrorCode.USER_NOT_FOUND, message)

return ApiResponse.error(ErrorCode.USER_NOT_FOUND, message, data);
```

### Service å±‚è§„èŒƒ

#### 1. æ¥å£å’Œå®ç°åˆ†ç¦»

```java
// æœåŠ¡æ¥å£
public interface UserService {
    User getByUsername(String username);
    User getById(Long id);
    void create(User user);
    void update(User user);
    void delete(Long id);
    PageResponse<User> list(Integer pageNum, Integer pageSize, String keyword);
}
```

#### 2. æœåŠ¡å®ç°ç±»

```java
/**
 * ç”¨æˆ·æœåŠ¡å®ç°ç±»
 * @Service: Springæ³¨è§£ï¼Œæ ‡è¯†æœåŠ¡å±‚ç»„ä»¶
 * @RequiredArgsConstructor: Lombokæ³¨è§£ï¼Œä¸ºfinalå­—æ®µç”Ÿæˆæ„é€ å‡½æ•°
 * @Transactional(readOnly = true): ç±»çº§åˆ«äº‹åŠ¡ï¼Œé»˜è®¤åªè¯»äº‹åŠ¡
 */
@Service
@RequiredArgsConstructor
@Transactional(readOnly = true)
public class UserServiceImpl implements UserService {

   private final UserMapper userMapper;

   @Override
   public User getByUsername(String username) {
      return userMapper.selectByUsername(username);
   }

   @Override
   public User getById(Long id) {
      return userMapper.selectById(id);
   }

   @Override
   @Transactional(rollbackFor = Exception.class)
   public void create(User user) {
      userMapper.insert(user);
   }

   @Override
   @Transactional(rollbackFor = Exception.class)
   public void update(User user) {
      userMapper.updateById(user);
   }

   @Override
   @Transactional(rollbackFor = Exception.class)
   public void delete(Long id) {
      userMapper.deleteById(id);
   }

   @Override
   public PageResponse<User> list(Integer pageNum, Integer pageSize, String keyword) {
      // ä½¿ç”¨ MyBatis-Plus åˆ†é¡µ
      IPage<User> page = userMapper.selectUsersByKeyword(new Page<>(pageNum, pageSize), keyword);
      return PageUtil.toPageResponse(page);
   }
}
```

**å…³é”®æ³¨è§£è¯´æ˜**:
- `@Service`: æ ‡è¯†æœåŠ¡å±‚ç»„ä»¶ï¼ŒSpringä¼šè‡ªåŠ¨æ‰«æå¹¶æ³¨å†Œä¸ºBean
- `@Transactional`: å£°æ˜å¼äº‹åŠ¡ç®¡ç†
  - `readOnly = true`: åªè¯»äº‹åŠ¡ï¼Œä¼˜åŒ–æ€§èƒ½
  - `rollbackFor = Exception.class`: é‡åˆ°ä»»ä½•å¼‚å¸¸éƒ½å›æ»š

é»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰å½“äº‹åŠ¡ä¸­çš„ä»£ç æŠ›å‡ºUnchecked Exceptionsæ—¶æ‰ä¼šå›æ»šï¼ˆå¦‚ NullPointerException, IllegalArgumentExceptionï¼‰ï¼Œè€ŒChecked Exceptionsï¼ˆå¦‚ IOException, SQLExceptionï¼‰ä¸ä¼šå›æ»šã€‚

ä½¿ç”¨`@Transactional(rollbackFor = Exception.class)`å¯ä»¥ä¿è¯é™¤äº†é»˜è®¤çš„ RuntimeException å’Œ Errorï¼Œå½“æ–¹æ³•æŠ›å‡ºä»»ä½• Exception åŠå…¶å­ç±»çš„å®ä¾‹æ—¶ï¼Œéƒ½å›æ»šå½“å‰äº‹åŠ¡.

**æ³¨æ„**ï¼šä¸¥ç¦åœ¨ServiceImplä¸­ä½¿ç”¨queryWrapperï¼Œæ‰€æœ‰sqlæ“ä½œéƒ½å¿…é¡»åœ¨mapperå±‚ä¸­å®ç°ï¼Œç®€å•çš„å¯ä»¥é€šè¿‡æ³¨è§£å†™sqlè¯­å¥ï¼Œå¤æ‚çš„åœ¨xmlä¸­å†™sqlè¯­å¥ã€‚

### Mapper å±‚è§„èŒƒ

#### 1. Mapperæ¥å£å®šä¹‰

```java
/**
 * ç”¨æˆ· Mapper æ¥å£
 * @Mapper: MyBatisæ³¨è§£ï¼Œæ ‡è¯†Mapperæ¥å£
 * extends BaseMapper<User>: ç»§æ‰¿MyBatis-PlusåŸºç¡€Mapperï¼Œè·å¾—åŸºæœ¬CRUDæ–¹æ³•
 */
@Mapper
public interface UserMapper extends BaseMapper<User> {

   /**
    * æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ· - ç®€å•æŸ¥è¯¢ï¼Œä½¿ç”¨æ³¨è§£
    */
   @Select("SELECT * FROM sys_user WHERE username = #{username} AND is_deleted = 0")
   User selectByUsername(@Param("username") String username);

   /**
    * æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ· - ç®€å•æŸ¥è¯¢ï¼Œä½¿ç”¨æ³¨è§£
    */
   @Select("SELECT * FROM sys_user WHERE phone = #{phone} AND is_deleted = 0")
   User selectByPhone(@Param("phone") String phone);

   /**
    * æ ¹æ®é‚®ç®±æŸ¥è¯¢ç”¨æˆ· - ç®€å•æŸ¥è¯¢ï¼Œä½¿ç”¨æ³¨è§£
    */
   @Select("SELECT * FROM sys_user WHERE email = #{email} AND is_deleted = 0")
   User selectByEmail(@Param("email") String email);

   /**
    * æ ¹æ®å…³é”®è¯åˆ†é¡µæŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨ - å¤æ‚æŸ¥è¯¢ï¼Œä½¿ç”¨XMLå®ç°
    */
   List<User> selectUsersByKeyword(@Param("keyword") String keyword);
}

```

**å…³é”®æ³¨è§£è¯´æ˜**:
- `@Mapper`: æ ‡è¯†MyBatis Mapperæ¥å£ï¼ŒSpringä¼šè‡ªåŠ¨åˆ›å»ºä»£ç†å®ç°
- `@Param`: ä¸ºæ–¹æ³•å‚æ•°æŒ‡å®šåç§°ï¼Œåœ¨XMLæ˜ å°„æ–‡ä»¶ä¸­ä½¿ç”¨

#### 2. æŸ¥è¯¢ç­–ç•¥è§„èŒƒ

**é‡è¦è§„èŒƒ**: æœ¬é¡¹ç›®é‡‡ç”¨åˆ†å±‚æŸ¥è¯¢ç­–ç•¥ï¼Œç¦æ­¢åœ¨ Service å±‚ä½¿ç”¨ QueryWrapper æˆ– LambdaQueryWrapperã€‚

**æŸ¥è¯¢ç­–ç•¥**:
1. **ç®€å•æŸ¥è¯¢**ï¼šä½¿ç”¨ `@Select` æ³¨è§£ç›´æ¥åœ¨ Mapper æ¥å£ä¸­å®šä¹‰ SQL
2. **å¤æ‚æŸ¥è¯¢**ï¼šä½¿ç”¨ XML æ˜ å°„æ–‡ä»¶å®šä¹‰ SQLï¼ˆåŠ¨æ€æ¡ä»¶ã€å¤šè¡¨JOINç­‰ï¼‰

**ç¤ºä¾‹**:
```java
// ç®€å•æŸ¥è¯¢ - ä½¿ç”¨æ³¨è§£
@Select("SELECT * FROM sys_user WHERE username = #{username} AND is_deleted = 0")
User selectByUsername(@Param("username") String username);

// å¤æ‚æŸ¥è¯¢ - ä½¿ç”¨XMLï¼ˆåŠ¨æ€æ¨¡ç³ŠæŸ¥è¯¢ï¼‰
List<User> selectUsersByKeyword(@Param("keyword") String keyword);
```

**XMLæ˜ å°„æ–‡ä»¶è§„èŒƒ** (ä»…ç”¨äºå¤æ‚æŸ¥è¯¢):

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dawnmoon.springboot_app_template.mapper.UserMapper">

    <!-- åªåŒ…å«å¤æ‚çš„æŸ¥è¯¢é€»è¾‘ï¼ˆåŠ¨æ€æ¡ä»¶ã€å¤šè¡¨JOINç­‰ï¼‰ -->
    <!-- ç®€å•æŸ¥è¯¢ç›´æ¥åœ¨Mapperæ¥å£ä¸­ä½¿ç”¨ @Select æ³¨è§£å®šä¹‰ -->

    <!-- æ ¹æ®å…³é”®è¯åˆ†é¡µæŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨ - å¤æ‚æŸ¥è¯¢ï¼Œä½¿ç”¨XMLå®ç° -->
    <select id="selectUsersByKeyword" resultType="com.dawnmoon.springboot_app_template.model.entity.User">
        SELECT * FROM sys_user
        WHERE is_deleted = 0
        <if test="keyword != null and keyword != ''">
            AND (
                username LIKE CONCAT('%', #{keyword}, '%')
                OR real_name LIKE CONCAT('%', #{keyword}, '%')
                OR phone LIKE CONCAT('%', #{keyword}, '%')
                OR email LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>
        ORDER BY create_at DESC
    </select>

</mapper>
```

**XMLæ˜ å°„è§„èŒƒ**:
- æ–‡ä»¶åå¿…é¡»ä¸ Mapper æ¥å£åä¸€è‡´ï¼š`UserMapper.xml`
- namespace å¿…é¡»ä¸ Mapper æ¥å£å…¨é™å®šåä¸€è‡´
- åªåŒ…å«å¤æ‚çš„æŸ¥è¯¢é€»è¾‘ï¼Œç®€å•æŸ¥è¯¢ä½¿ç”¨æ³¨è§£
- æ‰€æœ‰æŸ¥è¯¢å¿…é¡»åŒ…å« `AND is_deleted = 0`ï¼ˆé€»è¾‘åˆ é™¤æ¡ä»¶ï¼‰
- ä½¿ç”¨ `<if>` æ ‡ç­¾è¿›è¡Œæ¡ä»¶åˆ¤æ–­ï¼Œé¿å…åŠ¨æ€æ‹¼æ¥
- ä½¿ç”¨ CONCAT å‡½æ•°è¿›è¡Œæ¨¡ç³ŠæŸ¥è¯¢

---

## âš™ï¸ é…ç½®ç®¡ç†è§„èŒƒ

### å¤šç¯å¢ƒé…ç½®è§„èŒƒ

#### 1. é…ç½®æ–‡ä»¶å±‚æ¬¡ç»“æ„

```
application.yaml          # åŸºç¡€é…ç½®ï¼ˆæ‰€æœ‰ç¯å¢ƒé€šç”¨ï¼‰
â”œâ”€â”€ application-dev.yaml  # å¼€å‘ç¯å¢ƒé…ç½®
â”œâ”€â”€ application-test.yaml # æµ‹è¯•ç¯å¢ƒé…ç½®
â””â”€â”€ application-prod.yaml # ç”Ÿäº§ç¯å¢ƒé…ç½®
```

#### 2. åŸºç¡€é…ç½®æ–‡ä»¶ (application.yaml)

```yaml
spring:
  application:
    name: springboot-app-template
  # æ¿€æ´»çš„é…ç½®æ–‡ä»¶ - é€šè¿‡ Maven profiles æˆ–å¯åŠ¨å‚æ•°åˆ‡æ¢
  profiles:
    active: @profileActive@

# MyBatis-Plus åŸºç¡€é…ç½®
mybatis-plus:
  # Mapper XML æ–‡ä»¶ä½ç½®
  mapper-locations: classpath*:/mapper/**/*.xml
  # å®ä½“ç±»åŒ…è·¯å¾„
  type-aliases-package: com.dawnmoon.springboot_app_template.model.entity
  
  configuration:
    # é©¼å³°å‘½åè½¬æ¢ï¼šæ•°æ®åº“ä¸‹åˆ’çº¿ -> Javaé©¼å³°
    map-underscore-to-camel-case: true
    # è‡ªåŠ¨æ˜ å°„ç­–ç•¥ï¼šFULL å®Œå…¨æ˜ å°„
    auto-mapping-behavior: full
    # NULL å€¼å¤„ç†
    jdbc-type-for-null: 'null'
    # æ—¥å¿—å®ç°
    log-impl: org.apache.ibatis.logging.slf4j.Slf4jImpl

  global-config:
    # å…³é—­ MyBatis-Plus banner
    banner: false
    db-config:
      # ä¸»é”®ç±»å‹ï¼šé›ªèŠ±ç®—æ³•
      id-type: ASSIGN_ID
      # é€»è¾‘åˆ é™¤å­—æ®µåï¼ˆå…¨å±€é…ç½®ï¼‰
      logic-delete-field: isDeleted
      # é€»è¾‘åˆ é™¤å€¼ï¼ˆåˆ é™¤åçš„å€¼ï¼‰
      logic-delete-value: 1
      # é€»è¾‘æœªåˆ é™¤å€¼ï¼ˆæ­£å¸¸å€¼ï¼‰
      logic-not-delete-value: 0

# MyBatis-Plus åˆ†é¡µæ’ä»¶ç”± MybatisPlusInterceptor + PaginationInnerInterceptor å¯ç”¨
```

#### 3. å¼€å‘ç¯å¢ƒé…ç½® (application-dev.yaml)

```yaml
server:
  port: 8080

spring:
  # æ•°æ®æºé…ç½® - MySQL
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/springboot_template?useUnicode=true&characterEncoding=utf-8&serverTimezone=Asia/Shanghai&useSSL=false
    username: root
    password: root

    # Hikari è¿æ¥æ± é…ç½®
    hikari:
      minimum-idle: 5          # æœ€å°ç©ºé—²è¿æ¥æ•°
      maximum-pool-size: 20    # æœ€å¤§è¿æ¥æ•°
      connection-timeout: 30000 # è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
      max-lifetime: 1800000    # æœ€å¤§ç”Ÿå‘½å‘¨æœŸï¼ˆæ¯«ç§’ï¼‰
      idle-timeout: 600000     # ç©ºé—²è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
      connection-test-query: SELECT 1  # è¿æ¥æµ‹è¯•æŸ¥è¯¢

  # Redis é…ç½®
  data:
    redis:
      host: localhost
      port: 6379
      password:
      database: 0
      timeout: 5000ms
      lettuce:
        pool:
          max-active: 20
          max-wait: -1ms
          max-idle: 10
          min-idle: 0

# P6Spy SQL ç›‘æ§é…ç½®ï¼ˆå¼€å‘ç¯å¢ƒå¯ç”¨ï¼‰
decorator:
  datasource:
    p6spy:
      enable: true
      logging: slf4j
      multiline: true

# æ— éœ€é¢å¤–é…ç½®æ•°æ®åº“æ–¹è¨€ï¼Œæ’ä»¶è‡ªåŠ¨è¯†åˆ«

# æ—¥å¿—çº§åˆ«é…ç½® - å¼€å‘ç¯å¢ƒè¯¦ç»†æ—¥å¿—
logging:
  level:
    root: INFO
    com.dawnmoon.springboot_app_template: DEBUG
    com.dawnmoon.springboot_app_template.mapper: DEBUG
  pattern:
    console: '[%d{yyyy-MM-dd HH:mm:ss.SSS}] [%thread] [%-5level] [%X{traceId}] %logger{36} - %msg%n'
```

#### 4. ç”Ÿäº§ç¯å¢ƒé…ç½® (application-prod.yaml)

```yaml
server:
  port: 8080

spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    # ä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½®æ•æ„Ÿä¿¡æ¯
    url: jdbc:mysql://${DB_HOST:localhost}:${DB_PORT:3306}/${DB_NAME:springboot_template}?useUnicode=true&characterEncoding=utf-8&serverTimezone=Asia/Shanghai&useSSL=true
    username: ${DB_USERNAME:root}
    password: ${DB_PASSWORD:}
    hikari:
      minimum-idle: 10
      maximum-pool-size: 50
      connection-timeout: 30000

  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: 0

# ç”Ÿäº§ç¯å¢ƒå…³é—­SQLç›‘æ§
decorator:
  datasource:
    p6spy:
      enable: false

# ç”Ÿäº§ç¯å¢ƒæ—¥å¿—çº§åˆ«
logging:
  level:
    root: WARN
    com.dawnmoon.springboot_app_template: INFO
```

---

## ğŸ“Š æ•°æ®è®¿é—®è§„èŒƒ

### MyBatis-Plus é…ç½®

#### 1. é…ç½®ç±» (MybatisPlusConfig)

```java
/**
 * MyBatis-Plus é…ç½®ç±»
 * @Configuration: Springé…ç½®ç±»æ³¨è§£
 * @MapperScan: æŒ‡å®šMapperæ¥å£æ‰«æåŒ…è·¯å¾„
 */
@Configuration
@MapperScan("com.dawnmoon.springboot_app_template.mapper")
public class MybatisPlusConfig {

    /**
     * è‡ªåŠ¨å¡«å……å¤„ç†å™¨
     * @Slf4j: Lombokæ³¨è§£ï¼Œè‡ªåŠ¨ç”Ÿæˆlogå­—æ®µ
     * @Component: Springç»„ä»¶æ³¨è§£ï¼Œæ³¨å†Œä¸ºBean
     */
    @Slf4j
    @Component
    public static class MyMetaObjectHandler implements MetaObjectHandler {

        @Override
        public void insertFill(MetaObject metaObject) {
            log.debug("å¼€å§‹æ’å…¥å¡«å……...");

            // å¡«å……åˆ›å»ºæ—¶é—´å’Œæ›´æ–°æ—¶é—´
            this.strictInsertFill(metaObject, "createAt", LocalDateTime.class, LocalDateTime.now());
            this.strictInsertFill(metaObject, "updateAt", LocalDateTime.class, LocalDateTime.now());

            // å¡«å……åˆ›å»ºäººå’Œæ›´æ–°äººï¼ˆä»å½“å‰ç™»å½•ç”¨æˆ·è·å–ï¼‰
            Long currentUserId = SecurityUtil.getCurrentUserId();
            if (currentUserId != null) {
                this.strictInsertFill(metaObject, "createBy", Long.class, currentUserId);
                this.strictInsertFill(metaObject, "updateBy", Long.class, currentUserId);
            }
        }

        @Override
        public void updateFill(MetaObject metaObject) {
            log.debug("å¼€å§‹æ›´æ–°å¡«å……...");

            // å¡«å……æ›´æ–°æ—¶é—´å’Œæ›´æ–°äºº
            this.strictUpdateFill(metaObject, "updateAt", LocalDateTime.class, LocalDateTime.now());

            Long currentUserId = SecurityUtil.getCurrentUserId();
            if (currentUserId != null) {
                this.strictUpdateFill(metaObject, "updateBy", Long.class, currentUserId);
            }
        }
    }
}
```

**å…³é”®æ¥å£è¯´æ˜**:
- `MetaObjectHandler`: MyBatis-Plusè‡ªåŠ¨å¡«å……å¤„ç†å™¨æ¥å£
- `strictInsertFill()`: ä¸¥æ ¼æ¨¡å¼æ’å…¥å¡«å……ï¼Œåªæœ‰å­—æ®µä¸ºnullæ—¶æ‰å¡«å……
- `strictUpdateFill()`: ä¸¥æ ¼æ¨¡å¼æ›´æ–°å¡«å……

#### 2. åˆ†é¡µæŸ¥è¯¢è§„èŒƒ

**é‡è¦è§„èŒƒ**: æœ¬é¡¹ç›®ç¦æ­¢ä½¿ç”¨ MyBatis-Plus çš„ QueryWrapper æˆ– LambdaQueryWrapper è¿›è¡ŒåŠ¨æ€æŸ¥è¯¢ã€‚æ‰€æœ‰æ•°æ®åº“æŸ¥è¯¢å¿…é¡»é€šè¿‡ Mapper æ¥å£ä¸­å®šä¹‰çš„æ³¨è§£ SQL æˆ– XML æ˜ å°„æ–‡ä»¶å®ç°ã€‚

**æ›¿ä»£æ–¹æ¡ˆ**:
1. åœ¨ Mapper æ¥å£ä¸­å®šä¹‰è‡ªå®šä¹‰æŸ¥è¯¢æ–¹æ³•
2. åœ¨ XML æ˜ å°„æ–‡ä»¶ä¸­ç¼–å†™å¯¹åº”çš„ SQL è¯­å¥
3. åœ¨ Service ä¸­è°ƒç”¨è‡ªå®šä¹‰çš„ Mapper æ–¹æ³•

```java
// ä½¿ç”¨ MyBatis-Plus è¿›è¡Œåˆ†é¡µ
public PageResponse<User> list(Integer pageNum, Integer pageSize, String keyword) {
    IPage<User> page = userMapper.selectUsersByKeyword(new Page<>(pageNum, pageSize), keyword);
    return PageUtil.toPageResponse(page);
}
```

**åˆ†é¡µå·¥å…·ç±» (PageUtil)**:

```java
/**
 * åˆ†é¡µå·¥å…·ç±»
 * æä¾› IPage åˆ° PageResponse çš„è½¬æ¢æ–¹æ³•
 */
public class PageUtil {

    /**
     * å°† IPage è½¬æ¢ä¸º PageResponse
     */
    public static <T> PageResponse<T> toPageResponse(IPage<T> page) {
        PageResponse<T> response = new PageResponse<>();
        response.setTotal(page.getTotal());
        response.setPageNum((int) page.getCurrent());
        response.setPageSize((int) page.getSize());
        response.setPages((int) page.getPages());
        response.setList(page.getRecords());
        return response;
    }

    /**
     * å°† IPage è½¬æ¢ä¸º PageResponseï¼Œå¹¶å¯¹åˆ—è¡¨è¿›è¡Œè½¬æ¢
     * ç”¨äºEntityåˆ°VOçš„è½¬æ¢
     */
    public static <S, T> PageResponse<T> toPageResponse(IPage<S> page, Function<S, T> converter) {
        PageResponse<T> response = new PageResponse<>();
        response.setTotal(page.getTotal());
        response.setPageNum((int) page.getCurrent());
        response.setPageSize((int) page.getSize());
        response.setPages((int) page.getPages());

        List<T> convertedList = page.getRecords().stream()
                .map(converter)
                .collect(Collectors.toList());
        response.setList(convertedList);

        return response;
    }
}
```

---

## ğŸ“‹ API è®¾è®¡è§„èŒƒ

### ç»Ÿä¸€è¿”å›ä½“ (ApiResponse)

#### 1. è¿”å›ä½“ç»“æ„

```java
/**
 * ç»Ÿä¸€ API è¿”å›æ ¼å¼
 * @Data: Lombokæ³¨è§£ï¼Œç”Ÿæˆgetter/setteræ–¹æ³•
 * @NoArgsConstructor/@AllArgsConstructor: Lombokæ³¨è§£ï¼Œç”Ÿæˆæ„é€ å‡½æ•°
 * @JsonInclude(JsonInclude.Include.NON_NULL): Jacksonæ³¨è§£ï¼Œnullå€¼ä¸åºåˆ—åŒ–
 * @Schema: Swaggeræ–‡æ¡£æ³¨è§£ï¼Œæè¿°å“åº”ä½“ç»“æ„
 */
@Data
@NoArgsConstructor
@AllArgsConstructor
@JsonInclude(JsonInclude.Include.NON_NULL)
@Schema(description = "ç»Ÿä¸€å“åº”ä½“")
public class ApiResponse<T> implements Serializable {

    @Schema(description = "å“åº”ç ", example = "SUCCESS")
    private String code;

    @Schema(description = "å“åº”æ¶ˆæ¯", example = "æ“ä½œæˆåŠŸ")
    private String message;

    @Schema(description = "å“åº”æ•°æ®")
    private T data;

    @Schema(description = "æ—¶é—´æˆ³", example = "1719876543210")
    private Long timestamp;

    // é™æ€å·¥å‚æ–¹æ³•
    public static <T> ApiResponse<T> success() {
        return new ApiResponse<>(
            ErrorCode.SUCCESS.getCode(),
            ErrorCode.SUCCESS.getDescription(),
            null,
            System.currentTimeMillis()
        );
    }

    public static <T> ApiResponse<T> success(T data) {
        return new ApiResponse<>(
            ErrorCode.SUCCESS.getCode(),
            ErrorCode.SUCCESS.getDescription(),
            data,
            System.currentTimeMillis()
        );
    }

    public static <T> ApiResponse<T> error(ErrorCode errorCode) {
        return new ApiResponse<>(
            errorCode.getCode(),
            errorCode.getDescription(),
            null,
            System.currentTimeMillis()
        );
    }
}
```

#### 2. é”™è¯¯ç æšä¸¾ (ErrorCode)

```java
/**
 * ç»Ÿä¸€é”™è¯¯ç æšä¸¾
 * @Getter: Lombokæ³¨è§£ï¼Œç”Ÿæˆgetteræ–¹æ³•
 * implements BaseEnum<String>: å®ç°åŸºç¡€æšä¸¾æ¥å£
 */
@Getter
public enum ErrorCode implements BaseEnum<String> {

    // æˆåŠŸ
    SUCCESS("SUCCESS", "æ“ä½œæˆåŠŸ"),

    // å®¢æˆ·ç«¯é”™è¯¯ 4xx
    BAD_REQUEST("BAD_REQUEST", "è¯·æ±‚å‚æ•°é”™è¯¯"),
    UNAUTHORIZED("UNAUTHORIZED", "æœªè®¤è¯æˆ–è®¤è¯å·²è¿‡æœŸ"),
    FORBIDDEN("FORBIDDEN", "æ²¡æœ‰è®¿é—®æƒé™"),
    NOT_FOUND("NOT_FOUND", "è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨"),
    VALIDATE_FAILED("VALIDATE_FAILED", "å‚æ•°æ ¡éªŒå¤±è´¥"),

    // ä¸šåŠ¡é”™è¯¯ 5xx
    BUSINESS_ERROR("BUSINESS_ERROR", "ä¸šåŠ¡å¤„ç†å¤±è´¥"),
    INTERNAL_SERVER_ERROR("INTERNAL_SERVER_ERROR", "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯"),

    // ç”¨æˆ·ç›¸å…³é”™è¯¯
    USER_NOT_FOUND("USER_NOT_FOUND", "ç”¨æˆ·ä¸å­˜åœ¨"),
    USER_ALREADY_EXISTS("USER_ALREADY_EXISTS", "ç”¨æˆ·å·²å­˜åœ¨"),
    USERNAME_OR_PASSWORD_ERROR("USERNAME_OR_PASSWORD_ERROR", "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");

    private final String code;
    private final String description;

    ErrorCode(String code, String description) {
        this.code = code;
        this.description = description;
    }

    @Override
    public String getCode() {
        return code;
    }

    @Override
    public String getDescription() {
        return description;
    }
}
```

### è¯·æ±‚å‚æ•°è§„èŒƒ

#### 1. è¯·æ±‚å¯¹è±¡å®šä¹‰

```java
/**
 * è®¤è¯ç›¸å…³è¯·æ±‚å¯¹è±¡
 * ä½¿ç”¨å†…éƒ¨é™æ€ç±»ç»„ç»‡ç›¸å…³çš„è¯·æ±‚å¯¹è±¡
 */
public class AuthRequests {

    /**
     * ç™»å½•è¯·æ±‚
     * @Data: Lombokæ³¨è§£
     * @Schema: Swaggeræ–‡æ¡£æ³¨è§£ï¼Œæè¿°è¯·æ±‚ä½“
     */
    @Data
    @Schema(description = "ç™»å½•è¯·æ±‚")
    public static class LoginRequest {

        /**
         * @Schema: Swaggerå­—æ®µæè¿°
         * @NotBlank: Bean Validationæ³¨è§£ï¼Œä¸èƒ½ä¸ºnullä¸”å»é™¤ç©ºç™½å­—ç¬¦åé•¿åº¦å¤§äº0
         * @Size: Bean Validationæ³¨è§£ï¼Œé™åˆ¶å­—ç¬¦ä¸²é•¿åº¦
         */
        @Schema(description = "ç”¨æˆ·å", example = "admin")
        @NotBlank(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
        @Size(min = 3, max = 50, message = "ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-50ä¸ªå­—ç¬¦ä¹‹é—´")
        private String username;

        @Schema(description = "å¯†ç ", example = "123456")
        @NotBlank(message = "å¯†ç ä¸èƒ½ä¸ºç©º")
        @Size(min = 6, max = 100, message = "å¯†ç é•¿åº¦å¿…é¡»åœ¨6-100ä¸ªå­—ç¬¦ä¹‹é—´")
        private String password;
    }
}
```

**Bean Validation æ³¨è§£è¯´æ˜**:
- `@NotBlank`: å­—ç¬¦ä¸²ä¸èƒ½ä¸ºnullã€ç©ºå­—ç¬¦ä¸²æˆ–åªåŒ…å«ç©ºç™½å­—ç¬¦
- `@NotNull`: å€¼ä¸èƒ½ä¸ºnull
- `@Size`: é™åˆ¶å­—ç¬¦ä¸²ã€é›†åˆã€æ•°ç»„çš„å¤§å°
- `@Min/@Max`: é™åˆ¶æ•°å­—çš„æœ€å°/æœ€å¤§å€¼
- `@Email`: éªŒè¯é‚®ç®±æ ¼å¼
- `@Pattern`: æ­£åˆ™è¡¨è¾¾å¼éªŒè¯

---

## ğŸ“š å¼€å‘æµç¨‹è§„èŒƒ

### æ–°åŠŸèƒ½å¼€å‘æµç¨‹

#### 1. å®ä½“ç±»å¼€å‘
```java
// 1. ç»§æ‰¿BaseEntity
public class NewEntity extends BaseEntity {
    // 2. æ·»åŠ ä¸šåŠ¡å­—æ®µ
    // 3. ä½¿ç”¨åˆé€‚çš„MyBatis-Plusæ³¨è§£
}
```

#### 2. Mapperå¼€å‘
```java
// 1. ç»§æ‰¿BaseMapperè·å¾—åŸºç¡€CRUD
@Mapper
public interface NewEntityMapper extends BaseMapper<NewEntity> {
    // 2. æ·»åŠ è‡ªå®šä¹‰æŸ¥è¯¢æ–¹æ³•
}
```

#### 3. Serviceå¼€å‘
```java
// 1. å®šä¹‰æœåŠ¡æ¥å£
public interface NewEntityService {
    // å®šä¹‰ä¸šåŠ¡æ–¹æ³•
}

// 2. å®ç°æœåŠ¡ç±»
@Service
@RequiredArgsConstructor
@Transactional(readOnly = true)
public class NewEntityServiceImpl implements NewEntityService {
    // å®ç°ä¸šåŠ¡é€»è¾‘
}
```

#### 4. Controllerå¼€å‘
```java
// 1. æ·»åŠ å¿…è¦æ³¨è§£
@RestController
@RequestMapping("/api/newentity")
@RequiredArgsConstructor
@Validated
public class NewEntityController {
    // 2. å®ç°RESTæ¥å£
    // 3. ä½¿ç”¨ç»Ÿä¸€è¿”å›æ ¼å¼
}
```

### ä»£ç æäº¤è§„èŒƒ

#### 1. æäº¤ä¿¡æ¯æ ¼å¼
```
<type>: <subject>

<body>
```

#### 2. æäº¤ç±»å‹
- **feat**: æ–°åŠŸèƒ½
- **fix**: ä¿®å¤bug
- **doc**: æ–‡æ¡£æ›´æ–°
- **refactor**: ä»£ç é‡æ„
- **test**: æµ‹è¯•ç›¸å…³

#### 3. æäº¤ç¤ºä¾‹
```
feat: æ·»åŠ ç”¨æˆ·åˆ†é¡µæŸ¥è¯¢åŠŸèƒ½

- å®ç°ç”¨æˆ·åˆ—è¡¨åˆ†é¡µæŸ¥è¯¢API
- æ”¯æŒæŒ‰ç”¨æˆ·åã€æ‰‹æœºå·æ¨¡ç³Šæœç´¢
- æ·»åŠ ç›¸å…³å•å…ƒæµ‹è¯•
```

---

## ğŸ¯ æœ€ä½³å®è·µæ€»ç»“

### ä»£ç è´¨é‡æœ€ä½³å®è·µ

1. **æ³¨è§£ä½¿ç”¨è§„èŒƒ**
   - åˆç†ä½¿ç”¨Lombokæ³¨è§£å‡å°‘æ ·æ¿ä»£ç 
   - æ­£ç¡®é…ç½®MyBatis-Plusæ³¨è§£å®ç°è‡ªåŠ¨åŒ–
   - ä½¿ç”¨Bean Validationæ³¨è§£è¿›è¡Œå‚æ•°æ ¡éªŒ
   - æ·»åŠ Swaggeræ³¨è§£å®Œå–„APIæ–‡æ¡£

2. **åˆ†å±‚æ¶æ„å®è·µ**
   - Controllerå±‚åªå¤„ç†HTTPè¯·æ±‚å“åº”
   - Serviceå±‚å¤„ç†ä¸šåŠ¡é€»è¾‘å’Œäº‹åŠ¡
   - Mapperå±‚åªè´Ÿè´£æ•°æ®è®¿é—®
   - ä½¿ç”¨ç»Ÿä¸€çš„è¿”å›æ ¼å¼å’Œé”™è¯¯å¤„ç†

3. **é…ç½®ç®¡ç†å®è·µ**
   - å¤šç¯å¢ƒé…ç½®åˆ†ç¦»
   - æ•æ„Ÿä¿¡æ¯ä½¿ç”¨ç¯å¢ƒå˜é‡
   - åˆç†é…ç½®è¿æ¥æ± å’Œç¼“å­˜å‚æ•°

4. **æ•°æ®è®¿é—®å®è·µ**
   - ç»§æ‰¿BaseEntityç»Ÿä¸€åŸºç¡€å­—æ®µ
   - ä½¿ç”¨é€»è¾‘åˆ é™¤é¿å…ç‰©ç†åˆ é™¤
   - åˆç†ä½¿ç”¨åˆ†é¡µæŸ¥è¯¢é¿å…å¤§æ•°æ®é‡é—®é¢˜
   - åˆ©ç”¨è‡ªåŠ¨å¡«å……ç®€åŒ–å®¡è®¡å­—æ®µç®¡ç†

### å¼€å‘æ•ˆç‡æå‡

1. **å·¥å…·é“¾ä¼˜åŒ–**
   - ä½¿ç”¨Lombokå‡å°‘getter/setterç¼–å†™
   - ä½¿ç”¨MyBatis-Pluså‡å°‘åŸºç¡€CRUDä¸åˆ†é¡µå®ç°
   - ä½¿ç”¨P6Spyç›‘æ§SQLæ‰§è¡Œ

2. **ä»£ç å¤ç”¨**
   - BaseEntityæä¾›é€šç”¨å­—æ®µ
   - ApiResponseç»Ÿä¸€è¿”å›æ ¼å¼
   - PageUtilç»Ÿä¸€åˆ†é¡µè½¬æ¢
   - ErrorCodeç»Ÿä¸€é”™è¯¯ç ç®¡ç†

---

## ğŸ”’ å®‰å…¨ä¸è®¤è¯è§„èŒƒï¼ˆé˜¶æ®µä¸‰ï¼‰

### Spring Security 6.x é…ç½®è§„èŒƒ

#### 1. SecurityConfig é…ç½®ç±»

Spring Security 6.x ä½¿ç”¨ SecurityFilterChain Bean æ›¿ä»£ WebSecurityConfigurerAdapterï¼š

```java
@Configuration
@EnableWebSecurity
@EnableMethodSecurity // å¯ç”¨æ–¹æ³•çº§å®‰å…¨æ³¨è§£
@RequiredArgsConstructor
public class SecurityConfig {
    
    private final JwtAuthenticationFilter jwtAuthenticationFilter;
    private final RestAuthenticationEntryPoint restAuthenticationEntryPoint;
    private final RestAccessDeniedHandler restAccessDeniedHandler;
    
    /**
     * ç™½åå• - ä¸éœ€è¦è®¤è¯çš„è·¯å¾„
     */
    private static final String[] AUTH_WHITELIST = {
        "/api/auth/login",
        "/api/auth/register",
        "/doc.html",
        "/swagger-ui.html",
        "/swagger-ui/**",
        "/v3/api-docs/**",
        "/webjars/**",
        "/favicon.ico",
        "/error"
    };
    
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            // ç¦ç”¨ CSRFï¼ˆå‰åç«¯åˆ†ç¦»é¡¹ç›®ï¼‰
            .csrf(AbstractHttpConfigurer::disable)
            
            // é…ç½®æˆæƒè§„åˆ™
            .authorizeHttpRequests(authorize -> authorize
                .requestMatchers(AUTH_WHITELIST).permitAll()
                .anyRequest().authenticated()
            )
            
            // é…ç½®ä¼šè¯ç®¡ç†ï¼ˆæ— çŠ¶æ€ï¼‰
            .sessionManagement(session -> session
                .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            )
            
            // é…ç½®å¼‚å¸¸å¤„ç†
            .exceptionHandling(exception -> exception
                .authenticationEntryPoint(restAuthenticationEntryPoint)
                .accessDeniedHandler(restAccessDeniedHandler)
            )
            
            // æ·»åŠ  JWT è¿‡æ»¤å™¨
            .addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);
        
        return http.build();
    }
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}
```

**å…³é”®ç‚¹**ï¼š
- ä½¿ç”¨ Lambda DSL é…ç½®ï¼ˆSpring Security 6.x æ¨èæ–¹å¼ï¼‰
- æ— çŠ¶æ€ä¼šè¯ç®¡ç†ï¼ˆSessionCreationPolicy.STATELESSï¼‰
- è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†å™¨
- JWT è®¤è¯è¿‡æ»¤å™¨

#### 2. JWT è®¤è¯è¿‡æ»¤å™¨

```java
@Slf4j
@Component
@RequiredArgsConstructor
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    
    private final RedisTemplate<String, Object> redisTemplate;
    
    @Value("${app.security.token.prefix:token:}")
    private String tokenPrefix;
    
    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                  HttpServletResponse response,
                                  FilterChain filterChain) throws ServletException, IOException {
        
        // 1. ä»è¯·æ±‚å¤´è·å– Token
        String token = getTokenFromRequest(request);
        
        if (StringUtils.hasText(token)) {
            // 2. ä» Redis è·å–ç”¨æˆ·ä¿¡æ¯
            String redisKey = tokenPrefix + token;
            UserPrincipal userPrincipal = (UserPrincipal) redisTemplate.opsForValue().get(redisKey);
            
            if (userPrincipal != null) {
                // 3. åˆ›å»ºè®¤è¯å¯¹è±¡å¹¶è®¾ç½®åˆ° SecurityContext
                UsernamePasswordAuthenticationToken authentication =
                    new UsernamePasswordAuthenticationToken(
                        userPrincipal,
                        null,
                        userPrincipal.getAuthorities()
                    );
                authentication.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
                SecurityContextHolder.getContext().setAuthentication(authentication);
                
                // 4. åˆ·æ–° Token è¿‡æœŸæ—¶é—´ï¼ˆæ»‘åŠ¨è¿‡æœŸï¼‰
                Long ttl = redisTemplate.getExpire(redisKey, TimeUnit.SECONDS);
                if (ttl != null && ttl > 0 && ttl < 3600) {
                    redisTemplate.expire(redisKey, 24, TimeUnit.HOURS);
                }
            }
        }
        
        filterChain.doFilter(request, response);
    }
    
    private String getTokenFromRequest(HttpServletRequest request) {
        String bearerToken = request.getHeader("Authorization");
        if (StringUtils.hasText(bearerToken) && bearerToken.startsWith("Bearer ")) {
            return bearerToken.substring(7);
        }
        return null;
    }
}
```

**å…³é”®ç‚¹**ï¼š
- ç»§æ‰¿ OncePerRequestFilter ç¡®ä¿æ¯ä¸ªè¯·æ±‚åªæ‰§è¡Œä¸€æ¬¡
- ä» Redis ä¸­è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆè€Œä¸æ˜¯è§£æ JWTï¼‰
- å®ç°æ»‘åŠ¨è¿‡æœŸæœºåˆ¶
- Token æ ¼å¼ï¼š`Authorization: Bearer {token}`

### Redis Token è®¤è¯æœºåˆ¶

#### 1. åŒ Key ç»“æ„è®¾è®¡

ä¸ºå®ç°å•ç‚¹ç™»å½•å’Œå¿«é€ŸæŸ¥è¯¢ï¼Œä½¿ç”¨ä¸¤ç§ Redis Keyï¼š

```
1. token:{token} â†’ UserPrincipal å¯¹è±¡
   - ç”¨é€”ï¼šæ ¹æ® Token å¿«é€Ÿè·å–ç”¨æˆ·ä¿¡æ¯
   - è¿‡æœŸæ—¶é—´ï¼š24å°æ—¶ï¼ˆå¯é…ç½®ï¼‰
   
2. user_id_to_token:{userId} â†’ Token å­—ç¬¦ä¸²
   - ç”¨é€”ï¼šæ ¹æ® userId æŸ¥æ‰¾å½“å‰æœ‰æ•ˆçš„ Token
   - è¿‡æœŸæ—¶é—´ï¼šä¸ token:{token} ç›¸åŒ
```

**ä¼˜åŠ¿**ï¼š
- æ”¯æŒå•ç‚¹ç™»å½•/äº’è¸¢æœºåˆ¶
- æ”¯æŒç®¡ç†å‘˜å¼ºåˆ¶ç”¨æˆ·ä¸‹çº¿
- æ”¯æŒæŸ¥è¯¢åœ¨çº¿ç”¨æˆ·æ•°å’Œç™»å½•æ—¶é—´

#### 2. AuthService å®ç°

```java
@Slf4j
@Service
@RequiredArgsConstructor
public class AuthServiceImpl implements AuthService {
    
    private final RedisTemplate<String, Object> redisTemplate;
    private final UserService userService;
    private final PasswordEncoder passwordEncoder;
    
    @Value("${app.security.token.prefix:token:}")
    private String tokenKeyPrefix;
    
    @Value("${app.security.token.ttl:86400}")
    private long tokenTtlSeconds;
    
    private static final String USER_ID_TO_TOKEN_KEY_PREFIX = "user_id_to_token:";
    
    @Override
    public String login(AuthRequests.LoginRequest request) {
        // 1. éªŒè¯ç”¨æˆ·åå’Œå¯†ç 
        User user = userService.getByUsername(request.getUsername());
        if (user == null || !passwordEncoder.matches(request.getPassword(), user.getPassword())) {
            throw new BusinessException(ErrorCode.USERNAME_OR_PASSWORD_ERROR);
        }
        
        // 2. æ£€æŸ¥è´¦å·çŠ¶æ€
        if (!user.getEnabled()) {
            throw new BusinessException(ErrorCode.USER_ACCOUNT_DISABLED);
        }
        
        // 3. è¸¢å‡ºæ—§è®¾å¤‡ï¼ˆå•ç‚¹ç™»å½•ï¼‰
        String oldToken = (String) redisTemplate.opsForValue()
            .get(USER_ID_TO_TOKEN_KEY_PREFIX + user.getId());
        if (StringUtils.hasText(oldToken)) {
            redisTemplate.delete(tokenKeyPrefix + oldToken);
        }
        
        // 4. ç”Ÿæˆæ–° Token
        String newToken = UUID.randomUUID().toString().replace("-", "");
        
        // 5. åˆ›å»º UserPrincipal å¯¹è±¡ï¼ˆåŒ…å«ç™»å½•æ—¶é—´ï¼‰
        UserPrincipal userPrincipal = new UserPrincipal(
            user.getId(),
            user.getUsername(),
            null,
            user.getRoles(),
            user.getEnabled(),
            System.currentTimeMillis()
        );
        
        // 6. å­˜å‚¨åˆ° Redis
        redisTemplate.opsForValue().set(tokenKeyPrefix + newToken, userPrincipal, 
                                         tokenTtlSeconds, TimeUnit.SECONDS);
        redisTemplate.opsForValue().set(USER_ID_TO_TOKEN_KEY_PREFIX + user.getId(), newToken,
                                         tokenTtlSeconds, TimeUnit.SECONDS);
        
        return newToken;
    }
    
    @Override
    public void logoutSelf(String token) {
        // ç”¨æˆ·è‡ªå·±é€€å‡ºç™»å½•
        String tokenKey = tokenKeyPrefix + token;
        UserPrincipal userPrincipal = (UserPrincipal) redisTemplate.opsForValue().get(tokenKey);
        
        if (userPrincipal != null) {
            redisTemplate.delete(tokenKey);
            redisTemplate.delete(USER_ID_TO_TOKEN_KEY_PREFIX + userPrincipal.getUserId());
        }
    }
    
    @Override
    public void forceLogoutByAdmin(Long targetUserId) {
        // ç®¡ç†å‘˜å¼ºåˆ¶ç”¨æˆ·ä¸‹çº¿
        String token = (String) redisTemplate.opsForValue()
            .get(USER_ID_TO_TOKEN_KEY_PREFIX + targetUserId);
        
        if (StringUtils.hasText(token)) {
            redisTemplate.delete(tokenKeyPrefix + token);
            redisTemplate.delete(USER_ID_TO_TOKEN_KEY_PREFIX + targetUserId);
        }
    }
}
```

### åŠ å¯†å·¥å…·è§„èŒƒ

**é‡è¦è¯´æ˜**ï¼šæœ¬é¡¹ç›®é‡‡ç”¨æ‰‹åŠ¨åŠ å¯†æ–¹å¼ï¼Œä¸ä½¿ç”¨è‡ªåŠ¨åŠ è§£å¯†ç»„ä»¶ï¼ˆå¦‚ TypeHandlerï¼‰ï¼Œç¡®ä¿åŠ å¯†é€»è¾‘çš„æ˜ç¡®æ€§å’Œå¯æ§æ€§ã€‚

#### 1. BCrypt å¯†ç åŠ å¯†

**ç”¨é€”**ï¼šç”¨æˆ·å¯†ç å­˜å‚¨ï¼ˆä¸å¯é€†å“ˆå¸Œï¼‰

```java
@Component
public class CryptoUtil {
    
    private static final BCryptPasswordEncoder PASSWORD_ENCODER = new BCryptPasswordEncoder();
    
    /**
     * BCrypt åŠ å¯†
     */
    public static String bcryptEncode(String password) {
        return PASSWORD_ENCODER.encode(password);
    }
    
    /**
     * BCrypt éªŒè¯
     */
    public static boolean bcryptMatches(String rawPassword, String encodedPassword) {
        return PASSWORD_ENCODER.matches(rawPassword, encodedPassword);
    }
}
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- ç”¨æˆ·æ³¨å†Œæ—¶åŠ å¯†å¯†ç 
- ç”¨æˆ·ç™»å½•æ—¶éªŒè¯å¯†ç 
- å¯†ç é‡ç½®æ—¶åŠ å¯†æ–°å¯†ç 

#### 2. ECC æ•æ„Ÿæ•°æ®åŠ å¯†

**ç”¨é€”**ï¼šæ•æ„Ÿå­—æ®µåŠ å¯†ï¼ˆå¯é€†åŠ å¯†ï¼Œå¦‚æ‰‹æœºå·ã€èº«ä»½è¯å·ï¼‰
**æ³¨æ„**ï¼šéœ€è¦æ‰‹åŠ¨è°ƒç”¨ï¼Œä¸ä½¿ç”¨è‡ªåŠ¨åŠ è§£å¯†

```java
@Component
public class CryptoUtil {
    
    @Value("${app.crypto.ecc.public-key:}")
    private String eccPublicKeyStr;
    
    @Value("${app.crypto.ecc.private-key:}")
    private String eccPrivateKeyStr;
    
    private PublicKey eccPublicKey;
    private PrivateKey eccPrivateKey;
    
    static {
        Security.addProvider(new BouncyCastleProvider());
    }
    
    @PostConstruct
    public void init() {
        // ä»é…ç½®åŠ è½½å¯†é’¥
        if (eccPublicKeyStr != null && !eccPublicKeyStr.isEmpty()) {
            eccPublicKey = loadPublicKey(eccPublicKeyStr);
        }
        if (eccPrivateKeyStr != null && !eccPrivateKeyStr.isEmpty()) {
            eccPrivateKey = loadPrivateKey(eccPrivateKeyStr);
        }
    }
    
    /**
     * ECC åŠ å¯†
     */
    public String eccEncrypt(String data) throws Exception {
        Cipher cipher = Cipher.getInstance("ECIES", "BC");
        cipher.init(Cipher.ENCRYPT_MODE, eccPublicKey);
        byte[] encrypted = cipher.doFinal(data.getBytes(StandardCharsets.UTF_8));
        return Base64.getEncoder().encodeToString(encrypted);
    }
    
    /**
     * ECC è§£å¯†
     */
    public String eccDecrypt(String cipherText) throws Exception {
        Cipher cipher = Cipher.getInstance("ECIES", "BC");
        cipher.init(Cipher.DECRYPT_MODE, eccPrivateKey);
        byte[] decrypted = cipher.doFinal(Base64.getDecoder().decode(cipherText));
        return new String(decrypted, StandardCharsets.UTF_8);
    }
}
```

**ä½¿ç”¨æ–¹å¼**ï¼š

```java
// æ‰‹åŠ¨åŠ å¯†æ•æ„Ÿæ•°æ® - åœ¨ä¸šåŠ¡å±‚å¤„ç†
@Service
public class UserServiceImpl implements UserService {
    
    private final CryptoUtil cryptoUtil;
    
    public void saveUser(User user) {
        // æ‰‹åŠ¨åŠ å¯†æ‰‹æœºå·
        if (user.getPhone() != null) {
            String encryptedPhone = cryptoUtil.eccEncrypt(user.getPhone());
            user.setPhone(encryptedPhone);
        }
        userMapper.insert(user);
    }

    public User getUser(Long id) {
        User user = userMapper.selectById(id);
        if (user != null && user.getPhone() != null) {
            // æ‰‹åŠ¨è§£å¯†æ‰‹æœºå·
            String decryptedPhone = cryptoUtil.eccDecrypt(user.getPhone());
            user.setPhone(decryptedPhone);
        }
        return user;
    }
}
```

### è§’è‰²æƒé™ç®¡ç†è§„èŒƒ

#### 1. å®ä½“ç±»è®¾è®¡

```java
// è§’è‰²è¡¨
@TableName("sys_role")
public class Role extends BaseEntity {
    @TableField("role_name")
    private String roleName;  // å¦‚ï¼šADMINã€USERã€GUEST
    
    @TableField("description")
    private String description;
    
    @TableField("status")
    private Integer status;   // 0-å¯ç”¨ï¼Œ1-ç¦ç”¨
}

// ç”¨æˆ·è§’è‰²å…³è”è¡¨
@TableName("sys_user_role")
public class UserRole extends BaseEntity {
    @TableField("user_id")
    private Long userId;
    
    @TableField("role_id")
    private Long roleId;
}

// ç”¨æˆ·è¡¨ï¼ˆæ·»åŠ è§’è‰²å­—æ®µï¼‰
public class User extends BaseEntity {
    // ... å…¶ä»–å­—æ®µ
    
    @TableField(exist = false)
    private List<String> roles;  // è§’è‰²åˆ—è¡¨ï¼ˆä¸å­˜å‚¨åœ¨æ•°æ®åº“ï¼Œé€šè¿‡å…³è”æŸ¥è¯¢è·å–ï¼‰
    
    public Boolean getEnabled() {
        return status != null && status == 0;
    }
}
```

#### 2. è§’è‰²æŸ¥è¯¢

```java
@Mapper
public interface UserRoleMapper extends BaseMapper<UserRole> {
    
    /**
     * æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢è§’è‰²åç§°åˆ—è¡¨
     */
    @Select("SELECT r.role_name FROM sys_role r " +
            "INNER JOIN sys_user_role ur ON r.id = ur.role_id " +
            "WHERE ur.user_id = #{userId} AND r.is_deleted = 0 AND ur.is_deleted = 0")
    List<String> selectRoleNamesByUserId(Long userId);
}

// åœ¨ UserService ä¸­åŠ è½½è§’è‰²
public User getByUsername(String username) {
    User user = userMapper.selectByUsername(username);
    if (user != null) {
        user.setRoles(userRoleMapper.selectRoleNamesByUserId(user.getId()));
    }
    return user;
}
```

#### 3. æƒé™æ³¨è§£ä½¿ç”¨

```java
@RestController
@RequestMapping("/api/admin")
public class AdminController {
    
    /**
     * ç®¡ç†å‘˜ä¸“ç”¨æ¥å£
     */
    @PreAuthorize("hasRole('ADMIN')")
    @GetMapping("/users")
    public ApiResponse<List<User>> getAllUsers() {
        // ...
    }
    
    /**
     * éœ€è¦ ADMIN æˆ– MANAGER è§’è‰²
     */
    @PreAuthorize("hasAnyRole('ADMIN', 'MANAGER')")
    @PostMapping("/users")
    public ApiResponse<Void> createUser() {
        // ...
    }
}
```

### æ•°æ®åº“è„šæœ¬è§„èŒƒ

#### 1. DDL è„šæœ¬è§„èŒƒ

**MySQL ç¤ºä¾‹**ï¼š

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE `sys_user` (
    `id` BIGINT NOT NULL COMMENT 'ä¸»é”®IDï¼ˆé›ªèŠ±ç®—æ³•ï¼‰',
    `username` VARCHAR(50) NOT NULL COMMENT 'ç”¨æˆ·å',
    `password` VARCHAR(255) NOT NULL COMMENT 'å¯†ç ï¼ˆBCryptåŠ å¯†ï¼‰',
    `real_name` VARCHAR(50) NULL COMMENT 'çœŸå®å§“å',
    `phone` VARCHAR(20) NULL COMMENT 'æ‰‹æœºå·',
    `email` VARCHAR(100) NULL COMMENT 'é‚®ç®±',
    `avatar` VARCHAR(255) NULL COMMENT 'å¤´åƒURL',
    `status` TINYINT NOT NULL DEFAULT 0 COMMENT 'è´¦å·çŠ¶æ€ï¼š0-å¯ç”¨ï¼Œ1-ç¦ç”¨',
    `create_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    `update_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    `create_by` BIGINT NULL COMMENT 'åˆ›å»ºäºº',
    `update_by` BIGINT NULL COMMENT 'æ›´æ–°äºº',
    `is_deleted` TINYINT NOT NULL DEFAULT 0 COMMENT 'é€»è¾‘åˆ é™¤ï¼š0-æœªåˆ é™¤ï¼Œ1-å·²åˆ é™¤',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_username` (`username`),
    KEY `idx_status` (`status`),
    KEY `idx_is_deleted` (`is_deleted`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ç”¨æˆ·è¡¨';
```

**è§„èŒƒè¦ç‚¹**ï¼š
- ä½¿ç”¨ BIGINT ä½œä¸ºä¸»é”®ç±»å‹ï¼ˆæ”¯æŒé›ªèŠ±ç®—æ³•ï¼‰
- æ‰€æœ‰è¡¨åŒ…å« BaseEntity çš„åŸºç¡€å­—æ®µ
- åˆç†æ·»åŠ æ³¨é‡Š
- å¿…è¦å­—æ®µæ·»åŠ ç´¢å¼•
- ä½¿ç”¨ utf8mb4 å­—ç¬¦é›†

#### 2. æµ‹è¯•æ•°æ®è§„èŒƒ

```sql
-- è§’è‰²æ•°æ®
INSERT INTO `sys_role` VALUES
(1, 'ADMIN', 'ç³»ç»Ÿç®¡ç†å‘˜', 0, NOW(), NOW(), NULL, NULL, 0),
(2, 'USER', 'æ™®é€šç”¨æˆ·', 0, NOW(), NOW(), NULL, NULL, 0),
(3, 'GUEST', 'è®¿å®¢', 0, NOW(), NOW(), NULL, NULL, 0);

-- ç”¨æˆ·æ•°æ®ï¼ˆå¯†ç ä½¿ç”¨ BCrypt åŠ å¯†ï¼‰
INSERT INTO `sys_user` VALUES
(1001, 'admin', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8MYdLn2z/6N8uPHVqK', 
 'ç³»ç»Ÿç®¡ç†å‘˜', '13800138001', 'admin@example.com', NULL, 0, NOW(), NOW(), NULL, NULL, 0);

-- ç”¨æˆ·è§’è‰²å…³è”
INSERT INTO `sys_user_role` VALUES
(2001, 1001, 1, NOW(), NOW(), NULL, NULL, 0);
```

### å•å…ƒæµ‹è¯•è§„èŒƒ

#### 1. Service å±‚æµ‹è¯•

```java
@ExtendWith(MockitoExtension.class)
class AuthServiceTest {
    
    @Mock
    private RedisTemplate<String, Object> redisTemplate;
    
    @Mock
    private UserService userService;
    
    @Mock
    private PasswordEncoder passwordEncoder;
    
    @InjectMocks
    private AuthServiceImpl authService;
    
    @BeforeEach
    void setUp() {
        ReflectionTestUtils.setField(authService, "tokenKeyPrefix", "token:");
        ReflectionTestUtils.setField(authService, "tokenTtlSeconds", 86400L);
    }
    
    @Test
    void testLoginSuccess() {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        AuthRequests.LoginRequest request = new AuthRequests.LoginRequest();
        request.setUsername("admin");
        request.setPassword("admin123");
        
        User user = new User();
        user.setId(1001L);
        user.setUsername("admin");
        user.setPassword("$2a$10$encodedPassword");
        user.setStatus(0);
        user.setRoles(Arrays.asList("ADMIN", "USER"));
        
        // Mock è¡Œä¸º
        when(userService.getByUsername("admin")).thenReturn(user);
        when(passwordEncoder.matches("admin123", "$2a$10$encodedPassword")).thenReturn(true);
        
        // æ‰§è¡Œæµ‹è¯•
        String token = authService.login(request);
        
        // éªŒè¯ç»“æœ
        assertNotNull(token);
        assertFalse(token.isEmpty());
        verify(valueOperations, times(2)).set(anyString(), any(), anyLong(), any());
    }
}
```

### æœ€ä½³å®è·µæ€»ç»“ï¼ˆé˜¶æ®µä¸‰ï¼‰

#### 1. å®‰å…¨æ€§æœ€ä½³å®è·µ

- âœ… ä½¿ç”¨ BCrypt åŠ å¯†å¯†ç ï¼ˆä¸å¯é€†ï¼‰
- âœ… ä½¿ç”¨ ECC åŠ å¯†æ•æ„Ÿæ•°æ®ï¼ˆå¯é€†ï¼‰
- âœ… Token å­˜å‚¨åœ¨ Redis è€Œä¸æ˜¯ JWTï¼ˆæ”¯æŒå¼ºåˆ¶ä¸‹çº¿ï¼‰
- âœ… å®ç°æ»‘åŠ¨è¿‡æœŸæœºåˆ¶ï¼ˆæå‡ç”¨æˆ·ä½“éªŒï¼‰
- âœ… å®ç°å•ç‚¹ç™»å½•/äº’è¸¢æœºåˆ¶ï¼ˆå®‰å…¨æ€§ï¼‰
- âœ… å®ç°ç™½åå•æœºåˆ¶ï¼ˆç²¾ç¡®æ§åˆ¶å¼€æ”¾æ¥å£ï¼‰
- âœ… å¯†é’¥ä»é…ç½®æ–‡ä»¶æˆ–ç¯å¢ƒå˜é‡è¯»å–ï¼ˆä¸ç¡¬ç¼–ç ï¼‰

#### 2. æ¶æ„è®¾è®¡æœ€ä½³å®è·µ

- âœ… åŒ Key ç»“æ„è®¾è®¡ï¼ˆæ”¯æŒå¤šç§æŸ¥è¯¢åœºæ™¯ï¼‰
- âœ… æ— çŠ¶æ€ä¼šè¯ç®¡ç†ï¼ˆæ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²ï¼‰
- âœ… å¼‚å¸¸å¤„ç†å™¨ç»Ÿä¸€è¿”å›æ ¼å¼ï¼ˆAPI ä¸€è‡´æ€§ï¼‰
- âœ… è§’è‰²æƒé™åˆ†ç¦»è®¾è®¡ï¼ˆçµæ´»çš„æƒé™ç®¡ç†ï¼‰
- âœ… æ–¹æ³•çº§æƒé™æ§åˆ¶ï¼ˆ@PreAuthorizeï¼‰

#### 3. å¼€å‘æ•ˆç‡æå‡

- âœ… MyBatis-Plus è‡ªåŠ¨åŠ è§£å¯†ï¼ˆEncryptedTypeHandlerï¼‰
- âœ… Spring Security ç»Ÿä¸€è®¤è¯æµç¨‹
- âœ… å®Œå–„çš„å•å…ƒæµ‹è¯•ï¼ˆMock æ¡†æ¶ï¼‰
- âœ… å®Œæ•´çš„æ•°æ®åº“è„šæœ¬ï¼ˆå¿«é€Ÿåˆå§‹åŒ–ï¼‰

---

## ğŸš¨ å¼‚å¸¸å¤„ç†è§„èŒƒï¼ˆé˜¶æ®µå››ï¼‰

### å¼‚å¸¸åˆ†ç±»åŸåˆ™

#### 1. é¢„æœŸå¼‚å¸¸ï¼ˆChecked Exceptionsï¼‰
- **å®šä¹‰**: ä¸šåŠ¡é€»è¾‘ä¸­å¯é¢„æœŸçš„ã€æ­£å¸¸çš„é”™è¯¯æƒ…å†µ
- **å¤„ç†æ–¹å¼**: è®°å½• WARN æ—¥å¿—ï¼Œè¿”å›é”™è¯¯ç ï¼Œä¸è®°å½•å †æ ˆä¿¡æ¯
- **ç¤ºä¾‹**: å‚æ•°æ ¡éªŒå¤±è´¥ã€ç”¨æˆ·ä¸å­˜åœ¨ã€å¯†ç é”™è¯¯ã€æƒé™ä¸è¶³

#### 2. éé¢„æœŸå¼‚å¸¸ï¼ˆUnchecked Exceptionsï¼‰
- **å®šä¹‰**: ç¨‹åºè¿è¡Œæ—¶å‡ºç°çš„æŠ€æœ¯æ•…éšœ
- **å¤„ç†æ–¹å¼**: è®°å½• ERROR æ—¥å¿—ï¼Œè®°å½•å®Œæ•´å †æ ˆï¼Œè¿”å› 500 é”™è¯¯
- **ç¤ºä¾‹**: æ•°æ®åº“è¿æ¥å¤±è´¥ã€ç©ºæŒ‡é’ˆå¼‚å¸¸ã€é™¤é›¶å¼‚å¸¸

### ä¸šåŠ¡å¼‚å¸¸ç±» (BusinessException)

#### å®šä¹‰è§„èŒƒ

```java
package com.dawnmoon.springboot_app_template.common.exception;

import com.dawnmoon.springboot_app_template.common.enums.ErrorCode;
import lombok.Getter;

/**
 * ä¸šåŠ¡å¼‚å¸¸
 * ç”¨äºä¸šåŠ¡é€»è¾‘ä¸­çš„å¯é¢„æœŸå¼‚å¸¸ï¼Œä¸è®°å½•å †æ ˆè·Ÿè¸ª
 */
@Getter
public class BusinessException extends RuntimeException {

    private final ErrorCode errorCode;
    private final String message;

    /**
     * æ„é€ ä¸šåŠ¡å¼‚å¸¸ï¼ˆä½¿ç”¨é”™è¯¯ç ï¼‰
     */
    public BusinessException(ErrorCode errorCode) {
        super(errorCode.getDescription());
        this.errorCode = errorCode;
        this.message = errorCode.getDescription();
    }

    /**
     * æ„é€ ä¸šåŠ¡å¼‚å¸¸ï¼ˆä½¿ç”¨é”™è¯¯ç å’Œè‡ªå®šä¹‰æ¶ˆæ¯ï¼‰
     */
    public BusinessException(ErrorCode errorCode, String message) {
        super(message);
        this.errorCode = errorCode;
        this.message = message;
    }

    /**
     * æ„é€ ä¸šåŠ¡å¼‚å¸¸ï¼ˆä»…ä½¿ç”¨è‡ªå®šä¹‰æ¶ˆæ¯ï¼‰
     */
    public BusinessException(String message) {
        super(message);
        this.errorCode = ErrorCode.BUSINESS_ERROR;
        this.message = message;
    }
}
```

#### ä½¿ç”¨è§„èŒƒ

```java
// âœ… æ­£ç¡®ç¤ºä¾‹ 1: ä½¿ç”¨é”™è¯¯ç 
if (user == null) {
    throw new BusinessException(ErrorCode.USER_NOT_FOUND);
}

// âœ… æ­£ç¡®ç¤ºä¾‹ 2: ä½¿ç”¨é”™è¯¯ç  + è‡ªå®šä¹‰æ¶ˆæ¯
if (user == null) {
    throw new BusinessException(ErrorCode.USER_NOT_FOUND, "ç”¨æˆ·ID: " + userId + " ä¸å­˜åœ¨");
}

// âœ… æ­£ç¡®ç¤ºä¾‹ 3: ä½¿ç”¨è‡ªå®šä¹‰æ¶ˆæ¯
if (balance < amount) {
    throw new BusinessException("ä½™é¢ä¸è¶³ï¼Œå½“å‰ä½™é¢: " + balance);
}

// âŒ é”™è¯¯ç¤ºä¾‹: ä¸è¦ç”¨äºç³»ç»Ÿå¼‚å¸¸
try {
    database.connect();
} catch (SQLException e) {
    // âŒ é”™è¯¯ï¼šåº”è¯¥è®©å¼‚å¸¸å‘ä¸ŠæŠ›å‡ºï¼Œç”± GlobalExceptionHandler ç»Ÿä¸€å¤„ç†
    throw new BusinessException("æ•°æ®åº“è¿æ¥å¤±è´¥");
}
```

### å…¨å±€å¼‚å¸¸å¤„ç†å™¨ (GlobalExceptionHandler)

#### å®šä¹‰è§„èŒƒ

```java
package com.dawnmoon.springboot_app_template.common.exception;

import com.dawnmoon.springboot_app_template.common.api.ApiResponse;
import com.dawnmoon.springboot_app_template.common.enums.ErrorCode;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.ResponseStatus;
import org.springframework.web.bind.annotation.RestControllerAdvice;

/**
 * å…¨å±€å¼‚å¸¸å¤„ç†å™¨
 * ç»Ÿä¸€å¤„ç†åº”ç”¨ä¸­çš„æ‰€æœ‰å¼‚å¸¸ï¼Œå¹¶è¿”å›æ ‡å‡†åŒ–çš„é”™è¯¯å“åº”
 */
@Slf4j
@RestControllerAdvice
public class GlobalExceptionHandler {

    // é¢„æœŸå¼‚å¸¸ï¼šè¿”å› 200 çŠ¶æ€ç  + é”™è¯¯ç 
    @ExceptionHandler(BusinessException.class)
    @ResponseStatus(HttpStatus.OK)
    public ApiResponse<Void> handleBusinessException(BusinessException e) {
        log.warn("ä¸šåŠ¡å¼‚å¸¸: [{}] {}", e.getErrorCode().getCode(), e.getMessage());
        return ApiResponse.error(e.getErrorCode(), e.getMessage());
    }

    // éé¢„æœŸå¼‚å¸¸ï¼šè¿”å› 500 çŠ¶æ€ç  + å®Œæ•´å †æ ˆ
    @ExceptionHandler(Exception.class)
    @ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)
    public ApiResponse<Void> handleException(Exception e) {
        log.error("ç³»ç»Ÿå¼‚å¸¸", e);  // è®°å½•å®Œæ•´å †æ ˆ
        return ApiResponse.error(ErrorCode.INTERNAL_SERVER_ERROR, "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•");
    }
}
```

#### æ”¯æŒçš„å¼‚å¸¸ç±»å‹

| å¼‚å¸¸ç±»å‹ | HTTPçŠ¶æ€ç  | æ—¥å¿—çº§åˆ« | å †æ ˆè·Ÿè¸ª | è¯´æ˜ |
|---------|----------|---------|---------|------|
| `BusinessException` | 200 | WARN | å¦ | ä¸šåŠ¡å¼‚å¸¸ |
| `MethodArgumentNotValidException` | 200 | WARN | å¦ | @Valid å‚æ•°æ ¡éªŒå¼‚å¸¸ |
| `BindException` | 200 | WARN | å¦ | @Validated å‚æ•°ç»‘å®šå¼‚å¸¸ |
| `ConstraintViolationException` | 200 | WARN | å¦ | çº¦æŸè¿åå¼‚å¸¸ |
| `BadCredentialsException` | 200 | WARN | å¦ | è®¤è¯å¤±è´¥å¼‚å¸¸ |
| `AccessDeniedException` | 200 | WARN | å¦ | æƒé™ä¸è¶³å¼‚å¸¸ |
| `Exception` | 500 | ERROR | æ˜¯ | æ‰€æœ‰æœªæ•è·çš„å¼‚å¸¸ |

### å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ

#### 1. Controller å±‚

```java
@RestController
@RequestMapping("/api/user")
@RequiredArgsConstructor
public class UserController {
    
    private final UserService userService;
    
    /**
     * âœ… æ­£ç¡®ç¤ºä¾‹ï¼šä¸æ•è·å¼‚å¸¸ï¼Œè®© GlobalExceptionHandler ç»Ÿä¸€å¤„ç†
     */
    @GetMapping("/{id}")
    public ApiResponse<User> getById(@PathVariable Long id) {
        User user = userService.getById(id);
        return ApiResponse.success(user);
    }
    
    /**
     * âŒ é”™è¯¯ç¤ºä¾‹ï¼šä¸è¦åœ¨ Controller ä¸­ try-catch
     */
    @GetMapping("/{id}/bad")
    public ApiResponse<User> getByIdBad(@PathVariable Long id) {
        try {
            User user = userService.getById(id);
            return ApiResponse.success(user);
        } catch (BusinessException e) {
            // âŒ ä¸è¦è¿™æ ·åšï¼ŒGlobalExceptionHandler ä¼šè‡ªåŠ¨å¤„ç†
            return ApiResponse.error(e.getErrorCode(), e.getMessage());
        }
    }
}
```

#### 2. Service å±‚

```java
@Service
@RequiredArgsConstructor
public class UserServiceImpl implements UserService {
    
    private final UserMapper userMapper;
    
    /**
     * âœ… æ­£ç¡®ç¤ºä¾‹ï¼šæŠ›å‡ºä¸šåŠ¡å¼‚å¸¸
     */
    @Override
    public User getById(Long id) {
        User user = userMapper.selectById(id);
        if (user == null) {
            throw new BusinessException(ErrorCode.USER_NOT_FOUND);
        }
        return user;
    }
    
    /**
     * âœ… æ­£ç¡®ç¤ºä¾‹ï¼šç³»ç»Ÿå¼‚å¸¸ä¸æ•è·ï¼Œå‘ä¸ŠæŠ›å‡º
     */
    @Override
    public void updateUser(User user) {
        // å¦‚æœæ•°æ®åº“æ“ä½œå¤±è´¥ï¼Œä¼šæŠ›å‡º SQLException ç­‰ç³»ç»Ÿå¼‚å¸¸
        // ä¸è¦æ•è·ï¼Œè®© GlobalExceptionHandler ç»Ÿä¸€å¤„ç†
        userMapper.updateById(user);
    }
    
    /**
     * âŒ é”™è¯¯ç¤ºä¾‹ï¼šä¸è¦è¿”å› null
     */
    @Override
    public User getByIdBad(Long id) {
        User user = userMapper.selectById(id);
        // âŒ ä¸è¦è¿”å› nullï¼Œåº”è¯¥æŠ›å‡ºå¼‚å¸¸
        return user;
    }
}
```

#### 3. å‚æ•°æ ¡éªŒ

```java
/**
 * âœ… æ­£ç¡®ç¤ºä¾‹ï¼šä½¿ç”¨ @Valid æ³¨è§£è‡ªåŠ¨æ ¡éªŒ
 */
@PostMapping
public ApiResponse<Void> create(@RequestBody @Valid UserCreateRequest request) {
    // å¦‚æœæ ¡éªŒå¤±è´¥ï¼Œä¼šè‡ªåŠ¨æŠ›å‡º MethodArgumentNotValidException
    // GlobalExceptionHandler ä¼šæ•è·å¹¶è¿”å›é”™è¯¯ç 
    userService.create(request);
    return ApiResponse.success();
}

// è¯·æ±‚å¯¹è±¡å®šä¹‰
@Data
public class UserCreateRequest {
    
    @NotBlank(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    @Size(min = 3, max = 20, message = "ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-20ä¹‹é—´")
    private String username;
    
    @NotBlank(message = "å¯†ç ä¸èƒ½ä¸ºç©º")
    @Size(min = 6, max = 20, message = "å¯†ç é•¿åº¦å¿…é¡»åœ¨6-20ä¹‹é—´")
    private String password;
    
    @Email(message = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    private String email;
}
```

---

## ğŸ“Š æ—¥å¿—è¿½è¸ªè§„èŒƒï¼ˆé˜¶æ®µå››ï¼‰

### MDC é“¾è·¯è¿½è¸ªåŸç†

MDCï¼ˆMapped Diagnostic Contextï¼‰æ˜¯ SLF4J æä¾›çš„æ—¥å¿—ä¸Šä¸‹æ–‡æœºåˆ¶ï¼š
- åœ¨è¯·æ±‚å¼€å§‹æ—¶å°† traceId æ”¾å…¥ MDC
- å½“å‰çº¿ç¨‹çš„æ‰€æœ‰æ—¥å¿—éƒ½ä¼šåŒ…å«è¿™ä¸ª traceId
- åœ¨è¯·æ±‚ç»“æŸæ—¶æ¸…ç† MDCï¼Œé¿å…å†…å­˜æ³„æ¼

### TraceId è¿‡æ»¤å™¨ (TraceIdFilter)

#### å®šä¹‰è§„èŒƒ

```java
package com.dawnmoon.springboot_app_template.common.log;

import jakarta.servlet.*;
import jakarta.servlet.http.HttpServletRequest;
import lombok.extern.slf4j.Slf4j;
import org.slf4j.MDC;
import org.springframework.core.annotation.Order;
import org.springframework.stereotype.Component;

import java.io.IOException;
import java.util.UUID;

/**
 * TraceId è¿‡æ»¤å™¨
 * ä¸ºæ¯ä¸ªHTTPè¯·æ±‚ç”Ÿæˆå”¯ä¸€çš„traceIdï¼Œç”¨äºé“¾è·¯è¿½è¸ª
 */
@Slf4j
@Component
@Order(1)  // ç¡®ä¿è¯¥è¿‡æ»¤å™¨ä¼˜å…ˆæ‰§è¡Œ
public class TraceIdFilter implements Filter {

    private static final String TRACE_ID = "traceId";
    private static final String TRACE_ID_HEADER = "X-Trace-Id";

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
            throws IOException, ServletException {

        HttpServletRequest httpRequest = (HttpServletRequest) request;

        // 1. ä»è¯·æ±‚å¤´è·å– traceIdï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ç”Ÿæˆæ–°çš„
        String traceId = httpRequest.getHeader(TRACE_ID_HEADER);
        if (traceId == null || traceId.isEmpty()) {
            traceId = generateTraceId();
        }

        // 2. è®¾ç½®åˆ° MDCï¼Œåç»­æ‰€æœ‰æ—¥å¿—éƒ½ä¼šåŒ…å«è¿™ä¸ª traceId
        MDC.put(TRACE_ID, traceId);

        // 3. è®°å½•è¯·æ±‚å¼€å§‹æ—¶é—´
        long startTime = System.currentTimeMillis();

        try {
            // 4. æ‰§è¡Œè¯·æ±‚é“¾
            chain.doFilter(request, response);
        } finally {
            // 5. è®¡ç®—è¯·æ±‚è€—æ—¶
            long duration = System.currentTimeMillis() - startTime;

            // 6. è®°å½•è¯·æ±‚æ—¥å¿—ï¼ˆåŒ…å«æ–¹æ³•ã€URIã€è€—æ—¶ï¼‰
            String queryString = httpRequest.getQueryString();
            log.info("è¯·æ±‚å®Œæˆ: {} {} {} - è€—æ—¶: {}ms",
                    httpRequest.getMethod(),
                    httpRequest.getRequestURI(),
                    queryString != null ? "?" + queryString : "",
                    duration);

            // 7. æ¸…é™¤ MDCï¼Œé¿å…å†…å­˜æ³„æ¼ï¼ˆç‰¹åˆ«æ˜¯åœ¨ä½¿ç”¨çº¿ç¨‹æ± çš„æƒ…å†µä¸‹ï¼‰
            MDC.remove(TRACE_ID);
        }
    }

    /**
     * ç”Ÿæˆå”¯ä¸€çš„ TraceId
     */
    private String generateTraceId() {
        return UUID.randomUUID().toString().replace("-", "");
    }
}
```

### Logback é…ç½®è§„èŒƒ

#### æ—¥å¿—æ–‡ä»¶å‘½åè§„åˆ™

æŒ‰ç…§ç”¨æˆ·éœ€æ±‚ï¼Œæ—¥å¿—æ–‡ä»¶åæ ¼å¼ä¸ºï¼š`å¹´-æœˆ-æ—¥-æ—¶-åˆ†-ç§’.log`ï¼Œæ¯æ¬¡ç¨‹åºå¯åŠ¨åˆ›å»ºæ–°æ–‡ä»¶ã€‚

#### logback-spring.xml é…ç½®

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    
    <!-- ä»application.yamlè¯»å–æ—¥å¿—è·¯å¾„é…ç½® -->
    <springProperty scope="context" name="LOG_PATH" source="logging.file.path" defaultValue="logs"/>
    
    <!-- æ—¥å¿—æ ¼å¼å®šä¹‰ -->
    <property name="LOG_PATTERN"
              value="[%d{yyyy-MM-dd HH:mm:ss.SSS}] [%thread] [%-5level] [%X{traceId}] %logger{36} - %msg%n"/>

    <!-- æ§åˆ¶å°è¾“å‡ºé…ç½® -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>${LOG_PATTERN}</pattern>
            <charset>UTF-8</charset>
        </encoder>
    </appender>

    <!-- æ–‡ä»¶è¾“å‡ºé…ç½® - æ‰€æœ‰æ—¥å¿— -->
    <!-- ä½¿ç”¨timestampç”Ÿæˆå¯åŠ¨æ—¶çš„æ—¶é—´æˆ³ï¼Œä½œä¸ºæ–‡ä»¶å -->
    <timestamp key="startTime" datePattern="yyyy-MM-dd-HH-mm-ss"/>
    
    <appender name="FILE_ALL" class="ch.qos.logback.core.FileAppender">
        <file>${LOG_PATH}/${startTime}.log</file>
        <encoder>
            <pattern>${LOG_PATTERN}</pattern>
            <charset>UTF-8</charset>
        </encoder>
        <append>true</append>
    </appender>

    <!-- æ–‡ä»¶è¾“å‡ºé…ç½® - é”™è¯¯æ—¥å¿— -->
    <appender name="FILE_ERROR" class="ch.qos.logback.core.FileAppender">
        <file>${LOG_PATH}/${startTime}-error.log</file>
        <filter class="ch.qos.logback.classic.filter.LevelFilter">
            <level>ERROR</level>
            <onMatch>ACCEPT</onMatch>
            <onMismatch>DENY</onMismatch>
        </filter>
        <encoder>
            <pattern>${LOG_PATTERN}</pattern>
            <charset>UTF-8</charset>
        </encoder>
        <append>true</append>
    </appender>

    <!-- æ ¹æ—¥å¿—çº§åˆ«é…ç½® -->
    <root level="INFO">
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="FILE_ALL"/>
        <appender-ref ref="FILE_ERROR"/>
    </root>

    <!-- é¡¹ç›®æ—¥å¿—çº§åˆ«é…ç½® -->
    <logger name="com.dawnmoon.springboot_app_template" level="DEBUG" additivity="false">
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="FILE_ALL"/>
        <appender-ref ref="FILE_ERROR"/>
    </logger>
</configuration>
```

#### application.yaml é…ç½®

```yaml
# æ—¥å¿—é…ç½®
logging:
  # æ—¥å¿—æ–‡ä»¶è·¯å¾„
  file:
    path: logs
```

### æ—¥å¿—ä½¿ç”¨è§„èŒƒ

#### 1. æ—¥å¿—çº§åˆ«ä½¿ç”¨æ ‡å‡†

| çº§åˆ« | ä½¿ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|-----|---------|------|
| **ERROR** | ç³»ç»Ÿé”™è¯¯ã€æœªæ•è·å¼‚å¸¸ | `log.error("ç³»ç»Ÿå¼‚å¸¸", e)` |
| **WARN** | ä¸šåŠ¡å¼‚å¸¸ã€é¢„æœŸé”™è¯¯ | `log.warn("ç”¨æˆ·ä¸å­˜åœ¨: {}", userId)` |
| **INFO** | é‡è¦ä¸šåŠ¡æµç¨‹ã€çŠ¶æ€å˜æ›´ | `log.info("ç”¨æˆ·ç™»å½•æˆåŠŸ: {}", username)` |
| **DEBUG** | è°ƒè¯•ä¿¡æ¯ã€è¯¦ç»†æµç¨‹ | `log.debug("æŸ¥è¯¢å‚æ•°: {}", params)` |
| **TRACE** | éå¸¸è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ | `log.trace("æ–¹æ³•æ‰§è¡Œ: {}", methodName)` |

#### 2. æ—¥å¿—è¾“å‡ºæœ€ä½³å®è·µ

```java
@Service
@RequiredArgsConstructor
@Slf4j  // Lombok æ³¨è§£ï¼Œè‡ªåŠ¨ç”Ÿæˆ log å¯¹è±¡
public class UserServiceImpl implements UserService {
    
    /**
     * âœ… æ­£ç¡®ç¤ºä¾‹ï¼šä½¿ç”¨å ä½ç¬¦
     */
    @Override
    public User login(String username, String password) {
        log.info("ç”¨æˆ·ç™»å½•è¯·æ±‚: username={}", username);  // âœ… ä½¿ç”¨å ä½ç¬¦
        
        User user = userMapper.selectByUsername(username);
        if (user == null) {
            log.warn("ç”¨æˆ·ä¸å­˜åœ¨: {}", username);  // âœ… WARN çº§åˆ«
            throw new BusinessException(ErrorCode.USER_NOT_FOUND);
        }
        
        if (!passwordEncoder.matches(password, user.getPassword())) {
            log.warn("å¯†ç é”™è¯¯: username={}", username);  // âœ… ä¸è®°å½•å¯†ç 
            throw new BusinessException(ErrorCode.USERNAME_OR_PASSWORD_ERROR);
        }
        
        log.info("ç”¨æˆ·ç™»å½•æˆåŠŸ: userId={}, username={}", user.getId(), username);
        return user;
    }
    
    /**
     * âŒ é”™è¯¯ç¤ºä¾‹ï¼šä¸è¦ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥
     */
    @Override
    public User loginBad(String username, String password) {
        // âŒ å­—ç¬¦ä¸²æ‹¼æ¥ä¼šæ¶ˆè€—æ€§èƒ½ï¼Œå³ä½¿æ—¥å¿—çº§åˆ«ä¸å¤Ÿä¹Ÿä¼šæ‰§è¡Œæ‹¼æ¥
        log.info("ç”¨æˆ·ç™»å½•è¯·æ±‚: username=" + username);
        
        // âŒ ä¸è¦è®°å½•æ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç ã€èº«ä»½è¯å·ç­‰ï¼‰
        log.info("ç”¨æˆ·ç™»å½•: username={}, password={}", username, password);
        
        return null;
    }
}
```

#### 3. å¼‚å¸¸æ—¥å¿—è§„èŒƒ

```java
/**
 * âœ… æ­£ç¡®ç¤ºä¾‹ï¼šè®°å½•å®Œæ•´å¼‚å¸¸å †æ ˆ
 */
try {
    riskyOperation();
} catch (Exception e) {
    // âœ… è®°å½•å®Œæ•´å †æ ˆä¿¡æ¯
    log.error("æ“ä½œå¤±è´¥: {}", e.getMessage(), e);
    throw e;
}

/**
 * âŒ é”™è¯¯ç¤ºä¾‹ï¼šåªè®°å½•å¼‚å¸¸æ¶ˆæ¯
 */
try {
    riskyOperation();
} catch (Exception e) {
    // âŒ æ²¡æœ‰è®°å½•å †æ ˆä¿¡æ¯ï¼Œæ— æ³•å®šä½é—®é¢˜
    log.error("æ“ä½œå¤±è´¥: {}", e.getMessage());
    throw e;
}
```

### æ—¥å¿—æ–‡ä»¶ç®¡ç†

#### æ—¥å¿—æ–‡ä»¶ç»“æ„

```
logs/
â”œâ”€â”€ 2025-10-22-10-30-00.log        # æ™®é€šæ—¥å¿—
â”œâ”€â”€ 2025-10-22-10-30-00-error.log  # é”™è¯¯æ—¥å¿—
â”œâ”€â”€ 2025-10-22-14-15-30.log        # ä¸‹æ¬¡å¯åŠ¨çš„æ—¥å¿—
â””â”€â”€ 2025-10-22-14-15-30-error.log  # ä¸‹æ¬¡å¯åŠ¨çš„é”™è¯¯æ—¥å¿—
```

#### æ—¥å¿—æ¸…ç†ç­–ç•¥

å»ºè®®å®šæœŸæ¸…ç†æ—¥å¿—æ–‡ä»¶ï¼Œé¿å…ç£ç›˜ç©ºé—´å æ»¡ï¼š

```bash
# ä¿ç•™æœ€è¿‘ 7 å¤©çš„æ—¥å¿—
find logs/ -name "*.log" -mtime +7 -delete

# æˆ–ä½¿ç”¨ cron å®šæ—¶ä»»åŠ¡
0 2 * * * find /path/to/logs/ -name "*.log" -mtime +7 -delete
```

### é“¾è·¯è¿½è¸ªä½¿ç”¨åœºæ™¯

#### 1. åˆ†å¸ƒå¼è¿½è¸ª

```java
// å¾®æœåŠ¡é—´ä¼ é€’ traceId
RestTemplate restTemplate = new RestTemplate();
HttpHeaders headers = new HttpHeaders();
headers.set("X-Trace-Id", MDC.get("traceId"));

HttpEntity<String> entity = new HttpEntity<>(headers);
restTemplate.exchange(url, HttpMethod.GET, entity, String.class);
```

#### 2. æ—¥å¿—æŸ¥è¯¢

```bash
# æ ¹æ® traceId æŸ¥è¯¢å®Œæ•´è¯·æ±‚é“¾è·¯
grep "abc123def456" logs/2025-10-22-10-30-00.log
```

#### 3. æ—¥å¿—æ ¼å¼ç¤ºä¾‹

```
[2025-10-22 10:30:15.123] [http-nio-8080-exec-1] [INFO ] [abc123def456] c.d.s.c.AuthController - ç”¨æˆ·ç™»å½•è¯·æ±‚: username=admin
[2025-10-22 10:30:15.234] [http-nio-8080-exec-1] [DEBUG] [abc123def456] c.d.s.s.i.UserServiceImpl - æŸ¥è¯¢ç”¨æˆ·: username=admin
[2025-10-22 10:30:15.345] [http-nio-8080-exec-1] [INFO ] [abc123def456] c.d.s.s.i.AuthServiceImpl - ç”¨æˆ·ç™»å½•æˆåŠŸ: userId=1001
[2025-10-22 10:30:15.456] [http-nio-8080-exec-1] [INFO ] [abc123def456] c.d.s.c.l.TraceIdFilter - è¯·æ±‚å®Œæˆ: POST /api/auth/login  - è€—æ—¶: 333ms
```

### æœ€ä½³å®è·µæ€»ç»“ï¼ˆé˜¶æ®µå››ï¼‰

#### 1. å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ

- âœ… ä½¿ç”¨ BusinessException å¤„ç†ä¸šåŠ¡å¼‚å¸¸
- âœ… ä¸åœ¨ Controller ä¸­ try-catchï¼Œè®© GlobalExceptionHandler ç»Ÿä¸€å¤„ç†
- âœ… é¢„æœŸå¼‚å¸¸è®°å½• WARN æ—¥å¿—ï¼Œéé¢„æœŸå¼‚å¸¸è®°å½• ERROR æ—¥å¿—
- âœ… ä½¿ç”¨ @Valid å’Œ @Validated è¿›è¡Œå‚æ•°æ ¡éªŒ
- âœ… å¼‚å¸¸æ¶ˆæ¯æ¸…æ™°æ˜ç¡®ï¼Œä¾¿äºå®šä½é—®é¢˜

#### 2. æ—¥å¿—è¿½è¸ªæœ€ä½³å®è·µ

- âœ… ä½¿ç”¨ MDC å®ç°é“¾è·¯è¿½è¸ª
- âœ… æ¯ä¸ªè¯·æ±‚è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€ traceId
- âœ… æ—¥å¿—æ ¼å¼ç»Ÿä¸€ï¼ŒåŒ…å«æ—¶é—´ã€çº¿ç¨‹ã€çº§åˆ«ã€traceIdã€loggerã€æ¶ˆæ¯
- âœ… æ—¥å¿—æ–‡ä»¶æŒ‰å¯åŠ¨æ—¶é—´å‘½åï¼Œä¾¿äºå®šä½é—®é¢˜
- âœ… è®°å½•è¯·æ±‚è€—æ—¶ï¼Œä¾¿äºæ€§èƒ½åˆ†æ

#### 3. å¼€å‘æ•ˆç‡æå‡

- âœ… å…¨å±€å¼‚å¸¸å¤„ç†å™¨ç»Ÿä¸€è¿”å›æ ¼å¼
- âœ… TraceId è¿‡æ»¤å™¨è‡ªåŠ¨ç”Ÿæˆé“¾è·¯è¿½è¸ªID
- âœ… Logback é…ç½®çµæ´»ï¼Œæ”¯æŒå¤šç§è¾“å‡ºæ–¹å¼
- âœ… æµ‹è¯•è„šæœ¬ test_phase4.ps1 å¿«é€ŸéªŒè¯åŠŸèƒ½

---